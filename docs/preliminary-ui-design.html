import React, { useState, useCallback, useMemo, Fragment, useEffect, useRef, createContext, useContext } from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip } from 'recharts';
import { ShieldCheck, BrainCircuit, Landmark, BarChart2, CheckCircle, XCircle, Clock, Wallet, LogOut, Menu, X, Layers, Vote, Database, Search, Compass, ArrowUpRight, Calculator, ChevronLeft, Globe, Mail, Copy, Coins, List, BadgeCheck, Hourglass, LandmarkIcon, Zap, FileText, ImageIcon, Video, FileArchive, File as FileIcon, UploadCloud, Download, Link as LinkIcon, AlertTriangle, Eye, Sparkles, Image as ImageIconLucide, Send, PlusCircle, Paperclip, ArrowDown, ArrowUp } from 'lucide-react';
import { Transition } from '@headlessui/react';


// --- MOCK DATA ---
const STAKING_DATA = {
  totalStaked: 125430890.75,
  apy: 8.72,
};

const GOVERNANCE_STATS = {
    votingPeriod: "7 Days",
    depositRequired: 500,
    quorum: 40,
    threshold: 50,
    totalVotingPower: 90000000,
};

const WALLET_DATA = {
  lumeraBalance: 15234.88,
  stakedBalance: 5000.00,
};

const MY_DELEGATIONS = [
    { validatorName: 'CosmoStation', stakedAmount: 3500.00, claimableRewards: 88.43 },
    { validatorName: 'Figment', stakedAmount: 1500.00, claimableRewards: 37.00 }
];

const MY_UNSTAKING_DELEGATIONS = [
    { validatorName: 'Everstake', amount: 500.00, status: 'Unstaking', completionTime: new Date(Date.now() + 21 * 24 * 60 * 60 * 1000).toISOString() },
    { validatorName: 'P2P.org', amount: 250.00, status: 'Unstaking', completionTime: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString() }
];

const MY_STAKING_ACTIVITIES = [
    { txHash: 'A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2', result: 'Success', eventType: 'Claim Rewards', block: '12,345,678', amount: 88.43, time: '2 hours ago' },
    { txHash: 'B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3', result: 'Success', eventType: 'Delegate', block: '12,345,600', amount: 1000.00, time: '1 day ago' },
    { txHash: 'C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4E5F6A1B2C3D4', result: 'Success', eventType: 'Undelegate', block: '12,300,100', amount: 500.00, time: '3 days ago' },
];

const generateVoters = (voteCounts) => {
    const voters = [];
    const voteTypes = { For: voteCounts.for, No: voteCounts.no, Abstain: voteCounts.abstain, 'No with Veto': voteCounts.noWithVeto };
    for (const [type, count] of Object.entries(voteTypes)) {
        if (count > 0) {
            let remaining = count;
            const largeVoters = Math.floor(Math.random() * 5) + 2;
            for(let i=0; i<largeVoters; i++) {
                if(remaining < 1000) break;
                voters.push({ address: `lume1${[...Array(38)].map(() => Math.random().toString(36)[2]).join('')}`, vote: type });
                remaining -= (Math.random() * 0.3 + 0.1) * remaining;
            }
        }
    }
    return voters.sort(() => Math.random() - 0.5);
};

const GOVERNANCE_PROPOSALS = [
  { id: 'LIP-009', title: 'Emergency Security Patch for x/staking Module', status: 'Expedited', type: 'Software Upgrade', proposeDate: '2025-07-14T09:00:00Z', endDate: '2025-07-15T09:00:00Z', votes: { for: 1200000, no: 50000, abstain: 10000, noWithVeto: 20000 }, description: 'This is an emergency proposal to patch a critical vulnerability found in the x/staking module. An expedited voting period is requested to address this immediately.', deposit: 500.00, voters: generateVoters({ for: 1200000, no: 50000, abstain: 10000, noWithVeto: 20000 })},
  { id: 'LIP-008', title: 'Fund a new Community Marketing Initiative', status: 'Deposit', type: 'Text Proposal', proposeDate: '2025-07-13T10:00:00Z', endDate: '2025-07-20T23:59:59Z', votes: { for: 0, no: 0, abstain: 0, noWithVeto: 0 }, description: 'This proposal seeks to allocate 100,000 LUME to a community-led marketing campaign to increase brand awareness and attract new users to the Lumera ecosystem. The funds will be distributed to a multi-sig wallet controlled by community-elected representatives.', deposit: 50.00, voters: [] },
  { id: 'LIP-007', title: 'Integrate New Cross-Chain Bridge for Enhanced Liquidity', status: 'Voting', type: 'Parameter Change', proposeDate: '2025-07-08T14:30:00Z', endDate: '2025-07-15T23:59:59Z', votes: { for: 8200000, no: 1500000, abstain: 300000, noWithVeto: 100000 }, description: 'This proposal suggests integrating the Stargate bridge to allow seamless asset transfer from other major chains, aiming to increase TVL and trading volume within the Lumera ecosystem. This involves a change to the `x/bridge` module parameters.', deposit: 500.00, voters: generateVoters({ for: 8200000, no: 1500000, abstain: 300000, noWithVeto: 100000 }) },
  { id: 'LIP-006', title: 'Adjust Staking APY to Stabilize Token Emissions', status: 'Passed', type: 'Parameter Change', proposeDate: '2025-06-13T12:00:00Z', endDate: '2025-06-20T23:59:59Z', votes: { for: 11500000, no: 800000, abstain: 200000, noWithVeto: 50000 }, description: 'A proposal to slightly decrease the base staking APY from 9.5% to 8.72% to ensure long-term sustainability of the rewards pool.', deposit: 500.00, voters: generateVoters({ for: 11500000, no: 800000, abstain: 200000, noWithVeto: 50000 }) },
  { id: 'LIP-005', title: 'Community Grant for Lumera SDK Development', status: 'Rejected', type: 'Community Pool Spend', proposeDate: '2025-06-03T09:00:00Z', endDate: '2025-06-10T23:59:59Z', votes: { for: 4000000, no: 6500000, abstain: 500000, noWithVeto: 1200000 }, description: 'Proposal to allocate 500,000 LUME from the treasury to a community team for building a comprehensive JavaScript SDK.', deposit: 500.00, voters: generateVoters({ for: 4000000, no: 6500000, abstain: 500000, noWithVeto: 1200000 }) },
];

const RECENT_ACTIVITY = [
    { type: 'vote', action: 'Voted \'For\' on Proposal LIP-007', time: '3 hours ago', icon: <Vote className="w-5 h-5 text-indigo-400" /> },
    { type: 'stake', action: 'Staked 2,000 LUME', time: '2 days ago', icon: <Landmark className="w-5 h-5 text-teal-400" /> },
    { type: 'claim', action: 'Claimed 125.43 LUME in rewards', time: '2 days ago', icon: <BarChart2 className="w-5 h-5 text-amber-400" /> },
    { type: 'storage', action: 'Uploaded document to Cascade', time: '5 days ago', icon: <Database className="w-5 h-5 text-sky-400" /> },
];

const generateDelegators = (totalStaked) => {
    let delegators = [];
    let remainingStake = totalStaked;
    for (let i = 0; i < 35; i++) {
        const stake = Math.random() * (remainingStake / 3);
        remainingStake -= stake;
        delegators.push({
            address: `lume1${[...Array(38)].map(() => Math.random().toString(36)[2]).join('')}`,
            stakedAmount: stake
        });
        if (remainingStake <= 0) break;
    }
    return delegators;
};

const VALIDATORS = [
  { 
    name: 'CosmoStation', 
    stakedAmount: 12500000, 
    commission: 5.0, 
    votingPower: 7.8, 
    uptime: 99.98, 
    status: 'active',
    details: {
        description: "Cosmostation is an enterprise-level validator infrastructure provider and end-user application developer based in Seoul, South Korea. We are a team of engineers, designers, and dreamers who are passionate about building a transparent and decentralized future.",
        address: "lumevaloper1k2g3h4j5k6l7m8n9b0v1c2x3d4f5g6h7j8k9l",
        website: "https://www.cosmostation.io",
        securityContact: "security@cosmostation.io",
        status: "Bonded",
        delegators: generateDelegators(12500000),
    }
  },
  { 
    name: 'Figment', 
    stakedAmount: 11800000, 
    commission: 5.0, 
    votingPower: 7.5, 
    uptime: 99.99, 
    status: 'active',
    details: {
        description: "Figment provides the complete staking solution for 250+ institutional clients, including asset managers, exchanges, wallets, foundations, custodians, and large token holders, to earn rewards on their digital assets.",
        address: "lumevaloper2m3n4b5v6c7x8d9f0g1h2j3k4l5m6n7b8v9c",
        website: "https://www.figment.io",
        securityContact: "support@figment.io",
        status: "Bonded",
        delegators: generateDelegators(11800000),
    }
  },
  { 
    name: 'Everstake', 
    stakedAmount: 10500000, 
    commission: 7.0, 
    votingPower: 6.9, 
    uptime: 99.95, 
    status: 'active',
    details: {
        description: "Everstake is a trusted staking provider for the entire crypto world, run by a team of experienced developers, financial experts and blockchain enthusiasts. We use enterprise-level hardware to run nodes for the most popular PoS blockchains.",
        address: "lumevaloper3d4f5g6h7j8k9l0m1n2b3v4c5x6d7f8g9h0j",
        website: "https://everstake.one",
        securityContact: "inbox@everstake.one",
        status: "Bonded",
        delegators: generateDelegators(10500000),
    }
  },
  { 
    name: 'P2P.org', 
    stakedAmount: 9800000, 
    commission: 10.0, 
    votingPower: 6.5, 
    uptime: 99.80, 
    status: 'active',
    details: {
        description: "P2P Validator is a leading staking provider with a focus on decentralization and security.",
        address: "lumevaloper8v9c0x1z2a3s4d5f6g7h8j9k0l1m2n3b4v5c",
        website: "https://p2p.org",
        securityContact: "contact@p2p.org",
        status: "Bonded",
        delegators: generateDelegators(9800000),
    }
  },
  { 
    name: 'Jailed Validator', 
    stakedAmount: 250000, 
    commission: 100.0, 
    votingPower: 0.0, 
    uptime: 50.0, 
    status: 'inactive',
    details: {
        description: "This validator has been jailed for poor performance or malicious activity. Delegating to this validator is not recommended.",
        address: "lumevaloper9z8x7c6v5b4n3m2l1k0j9h8g7f6d5s4a3q2w",
        website: "https://example.com",
        securityContact: "contact@example.com",
        status: "Unbonded",
        delegators: generateDelegators(250000),
    }
  },
];

const AI_MODELS = [
    { name: "Llama 3 70B", owner: "lume1...k9l", fee: 0.5, prompted: 125890 },
    { name: "Stable Diffusion XL", owner: "lume1...v9c", fee: 0.2, prompted: 890543 },
    { name: "Mixtral 8x7B", owner: "lume1...h0j", fee: 0.4, prompted: 345678 },
    { name: "Claude 3 Sonnet", owner: "lume1...v5c", fee: 0.6, prompted: 78901 },
    { name: "Gemma 7B", owner: "lume1...q2w", fee: 0.1, prompted: 1234567 },
];

// --- HELPER COMPONENTS ---

const Card = ({ children, className = '' }) => (
  <div className={`bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-2xl p-6 shadow-lg transition-all duration-300 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, className = '', variant = 'primary' }) => {
  const baseClasses = 'px-6 py-2.5 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-2 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900';
  const variants = {
    primary: 'bg-indigo-600 text-white hover:bg-indigo-500 focus:ring-indigo-500',
    secondary: 'bg-gray-700 text-gray-200 hover:bg-gray-600 focus:ring-gray-500',
    ghost: 'bg-transparent text-gray-300 hover:bg-gray-700/50',
  };
  return <button onClick={onClick} className={`${baseClasses} ${variants[variant]} ${className}`}>{children}</button>;
};

const StatusPill = ({ status }) => {
  const styles = {
    Voting: 'bg-teal-500/20 text-teal-300 border border-teal-500/30',
    Passed: 'bg-green-500/20 text-green-300 border border-green-500/30',
    Rejected: 'bg-red-500/20 text-red-300 border border-red-500/30',
    Deposit: 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30',
    Expedited: 'bg-purple-500/20 text-purple-300 border border-purple-500/30',
  };
  const icons = {
      Voting: <Clock className="w-4 h-4" />,
      Passed: <CheckCircle className="w-4 h-4" />,
      Rejected: <XCircle className="w-4 h-4" />,
      Deposit: <Coins className="w-4 h-4" />,
      Expedited: <Zap className="w-4 h-4" />
  }
  return (
    <div className={`flex items-center gap-2 text-sm font-medium px-3 py-1 rounded-full ${styles[status]}`}>
        {icons[status] || <div/>}
        {status}
    </div>
  );
};


// --- CORE COMPONENTS ---

const Sidebar = ({ onNavClick, activeView, isSidebarOpen, setSidebarOpen }) => {
  const navItems = [
    { id: 'dashboard', label: 'Dashboard', icon: <BarChart2 className="w-5 h-5" /> },
    { id: 'staking', label: 'Staking', icon: <Landmark className="w-5 h-5" /> },
    { id: 'governance', label: 'Governance', icon: <Vote className="w-5 h-5" /> },
    { id: 'cascade', label: 'Cascade', icon: <Database className="w-5 h-5" /> },
    { id: 'sense', label: 'Sense', icon: <ShieldCheck className="w-5 h-5" /> },
    { id: 'inference', label: 'Inference', icon: <BrainCircuit className="w-5 h-5" /> },
    { id: 'nfts', label: 'NFTs', icon: <ImageIconLucide className="w-5 h-5" /> },
  ];
  
  const externalLinks = [
    { id: 'explorer', label: 'Explorer', icon: <Compass className="w-5 h-5" />, href: '#' },
  ];

  const NavContent = () => (
    <div className="flex flex-col h-full">
      <div className="flex items-center gap-3 px-6 py-5 border-b border-gray-800">
        <Layers className="w-8 h-8 text-indigo-500" />
        <h1 className="text-2xl font-bold text-white tracking-tight">Lumera</h1>
      </div>
      <nav className="flex-1 px-4 py-6 space-y-2">
        <p className="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Menu</p>
        {navItems.map(item => (
          <a
            key={item.id}
            href="#"
            onClick={(e) => { e.preventDefault(); onNavClick(item.id); setSidebarOpen(false); }}
            className={`flex items-center gap-3 px-4 py-3 rounded-lg text-base font-medium transition-colors duration-200 ${activeView === item.id ? 'text-white bg-indigo-600/30' : 'text-gray-400 hover:text-white hover:bg-gray-700/50'}`}
          >
            {item.icon}
            <span>{item.label}</span>
          </a>
        ))}
        <p className="px-4 pt-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Links</p>
        {externalLinks.map(item => (
            <a
                key={item.id}
                href={item.href}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-3 px-4 py-3 rounded-lg text-base font-medium text-gray-400 hover:text-white hover:bg-gray-700/50 transition-colors duration-200"
            >
                {item.icon}
                <span>{item.label}</span>
                <ArrowUpRight className="w-4 h-4 ml-auto text-gray-500" />
            </a>
        ))}
      </nav>
      <div className="px-6 py-4 mt-auto border-t border-gray-800 text-center text-xs text-gray-500">
        &copy; {new Date().getFullYear()} Lumera
      </div>
    </div>
  );

  return (
    <>
      <div className="hidden lg:flex lg:w-72 lg:flex-col lg:fixed lg:inset-y-0">
        <div className="flex flex-col flex-grow bg-gray-900 border-r border-gray-800/50">
          <NavContent />
        </div>
      </div>
      <Transition.Root show={isSidebarOpen} as={Fragment}>
        <div className="lg:hidden" role="dialog" aria-modal="true">
          <Transition.Child as={Fragment} enter="transition-opacity ease-linear duration-300" enterFrom="opacity-0" enterTo="opacity-100" leave="transition-opacity ease-linear duration-300" leaveFrom="opacity-100" leaveTo="opacity-0">
            <div onClick={() => setSidebarOpen(false)} className="fixed inset-0 bg-gray-900/80" />
          </Transition.Child>
          <div className="fixed inset-0 flex">
            <Transition.Child as={Fragment} enter="transition ease-in-out duration-300 transform" enterFrom="-translate-x-full" enterTo="translate-x-0" leave="transition ease-in-out duration-300 transform" leaveFrom="translate-x-0" leaveTo="-translate-x-full">
              <div className="relative mr-16 flex w-full max-w-xs flex-1">
                <div className="flex flex-grow flex-col bg-gray-900 border-r border-gray-800/50">
                  <NavContent />
                </div>
              </div>
            </Transition.Child>
          </div>
        </div>
      </Transition.Root>
    </>
  );
};


const Header = ({ setSidebarOpen, walletConnected, setWalletConnected, setView, activeView }) => {
  const viewTitles = { dashboard: "Dashboard", staking: "Staking", governance: "Governance", cascade: "Cascade", sense: "Sense", inference: "Inference", nfts: "NFTs" };
  const handleConnect = () => setWalletConnected(true);
  const handleDisconnect = () => { setWalletConnected(false); setView('dashboard'); };

  return (
    <div className="sticky top-0 z-10 flex h-16 flex-shrink-0 bg-gray-900/70 backdrop-blur-lg border-b border-gray-800/50">
      <button type="button" className="border-r border-gray-800 px-4 text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500 lg:hidden" onClick={() => setSidebarOpen(true)}>
        <Menu className="h-6 w-6" aria-hidden="true" />
      </button>
      <div className="flex flex-1 justify-between px-4 sm:px-6 lg:px-8">
        <div className="flex flex-1 items-center">
           <h1 className="text-2xl font-bold text-white">{viewTitles[activeView]}</h1>
        </div>
        <div className="ml-4 flex items-center md:ml-6">
          {walletConnected ? (
              <div className="flex items-center gap-3">
                <div className="bg-gray-800 px-4 py-2 rounded-lg text-sm"><span className="text-gray-400">0x1A2...b3C4</span></div>
                <Button onClick={handleDisconnect} variant="secondary" className="!px-3 !py-2"><LogOut className="w-5 h-5" /></Button>
              </div>
          ) : ( <Button onClick={handleConnect}><Wallet className="w-5 h-5" /> Connect Wallet</Button> )}
        </div>
      </div>
    </div>
  );
};

const Dashboard = ({ onNavClick }) => {
    const pieData = [ { name: 'Staked', value: WALLET_DATA.stakedBalance }, { name: 'Liquid', value: WALLET_DATA.lumeraBalance } ];
    const COLORS = ['#4f46e5', '#38bdf8'];
    const totalRewards = useMemo(() => MY_DELEGATIONS.reduce((acc, d) => acc + d.claimableRewards, 0), []);
    return (
        <div className="space-y-8">
             <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-8">
                <Card className="md:col-span-2">
                    <h2 className="text-xl font-semibold text-white mb-4">Portfolio Overview</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 items-center">
                        <div className="h-48">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie data={pieData} cx="50%" cy="50%" innerRadius={50} outerRadius={70} fill="#8884d8" paddingAngle={5} dataKey="value">{pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} stroke={COLORS[index % COLORS.length]} />)}</Pie>
                                    <Tooltip contentStyle={{ backgroundColor: '#1f2937', borderColor: '#4b5563', borderRadius: '0.75rem' }} itemStyle={{color: '#e5e7eb'}} />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="space-y-4">
                            <div>
                               <div className="flex items-center gap-2 text-gray-400 text-sm"><div className="w-3 h-3 rounded-full bg-indigo-500"></div>Staked</div>
                               <p className="text-3xl font-bold text-white break-words">{WALLET_DATA.stakedBalance.toLocaleString()} LUME</p>
                            </div>
                            <div>
                               <div className="flex items-center gap-2 text-gray-400 text-sm"><div className="w-3 h-3 rounded-full bg-sky-500"></div>Liquid</div>
                               <p className="text-3xl font-bold text-white break-words">{WALLET_DATA.lumeraBalance.toLocaleString()} LUME</p>
                            </div>
                        </div>
                    </div>
                </Card>
                <Card>
                    <h3 className="font-semibold text-gray-400">Total Balance</h3>
                    <p className="text-3xl sm:text-4xl xl:text-5xl font-bold text-white mt-2 break-words">{(WALLET_DATA.lumeraBalance + WALLET_DATA.stakedBalance).toLocaleString()}</p>
                    <p className="text-gray-400">LUME</p>
                </Card>
                <Card>
                    <h3 className="font-semibold text-gray-400">Claimable Rewards</h3>
                    <p className="text-3xl sm:text-4xl xl:text-5xl font-bold text-teal-400 mt-2">{totalRewards.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                    <Button variant="secondary" className="w-full mt-4 !py-3 text-sm" onClick={() => onNavClick('staking')}>Claim All Rewards</Button>
                </Card>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div className="lg:col-span-2 space-y-8">
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                             <h2 className="text-xl font-semibold text-white">Active Governance Proposals</h2>
                             <a href="#" onClick={(e) => {e.preventDefault(); onNavClick('governance')}} className="text-sm text-indigo-400 hover:underline">View All</a>
                        </div>
                        <div className="space-y-4">{GOVERNANCE_PROPOSALS.filter(p => p.status === 'Voting').map(p => (
                            <div key={p.id} className="bg-gray-900/50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <div><p className="font-semibold text-white">{p.title}</p><p className="text-sm text-gray-400">{p.id}</p></div>
                                <Button onClick={() => onNavClick('governance')}>Vote Now</Button>
                            </div>
                        ))}</div>
                    </Card>
                </div>
                 <Card className="lg:col-span-1">
                    <h2 className="text-xl font-semibold text-white mb-4">Recent Activity</h2>
                    <ul className="space-y-4">{RECENT_ACTIVITY.map((activity, index) => (
                       <li key={index} className="flex items-center gap-4">
                           <div className="bg-gray-700/50 p-2 rounded-full">{activity.icon}</div>
                           <div><p className="text-white text-sm">{activity.action}</p><p className="text-gray-500 text-xs">{activity.time}</p></div>
                       </li>
                    ))}</ul>
                </Card>
            </div>
        </div>
    );
};

const Staking = () => {
    const [selectedValidator, setSelectedValidator] = useState(null);
    const [activeTab, setActiveTab] = useState('allValidators');

    if (selectedValidator) {
        return <ValidatorDetail validator={selectedValidator} onBack={() => setSelectedValidator(null)} />;
    }

    return (
        <div className="space-y-8">
            <div className="border-b border-gray-700">
                <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                    <button
                        onClick={() => setActiveTab('allValidators')}
                        className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg ${activeTab === 'allValidators' ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-gray-400 hover:text-white hover:border-gray-300'}`}
                    >
                        All Validators
                    </button>
                    <button
                        onClick={() => setActiveTab('myStaking')}
                        className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg ${activeTab === 'myStaking' ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-gray-400 hover:text-white hover:border-gray-300'}`}
                    >
                        My Staking
                    </button>
                </nav>
            </div>
            <div className="mt-8">
                {activeTab === 'myStaking' && <MyStaking onSelectValidator={setSelectedValidator}/>}
                {activeTab === 'allValidators' && <AllValidators onSelectValidator={setSelectedValidator} />}
            </div>
        </div>
    );
}

const MyStaking = ({ onSelectValidator }) => {
    const [subTab, setSubTab] = useState('delegations');
    const totalStaked = useMemo(() => MY_DELEGATIONS.reduce((acc, d) => acc + d.stakedAmount, 0), []);
    const totalRewards = useMemo(() => MY_DELEGATIONS.reduce((acc, d) => acc + d.claimableRewards, 0), []);
    
    return (
        <Card>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                <div>
                    <p className="text-sm text-gray-400">Total Staked</p>
                    <p className="text-2xl sm:text-3xl font-bold text-white">{totalStaked.toLocaleString()} LUME</p>
                </div>
                <div>
                    <p className="text-sm text-gray-400">Staking Value</p>
                    <p className="text-2xl sm:text-3xl font-bold text-white">$ TBD</p>
                </div>
                <div>
                    <p className="text-sm text-gray-400">Claimable Rewards</p>
                    <p className="text-2xl sm:text-3xl font-bold text-teal-400">{totalRewards.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} LUME</p>
                </div>
            </div>
            <Button className="w-full md:w-auto"><Coins className="w-5 h-5"/>Claim All Rewards</Button>

            <div className="mt-8 border-t border-gray-700 pt-6">
                <div className="flex border-b border-gray-700">
                    <button onClick={() => setSubTab('delegations')} className={`px-4 py-2 font-medium ${subTab === 'delegations' ? 'text-white border-b-2 border-indigo-500' : 'text-gray-400 hover:text-white'}`}>Delegations</button>
                    <button onClick={() => setSubTab('unstake')} className={`px-4 py-2 font-medium ${subTab === 'unstake' ? 'text-white border-b-2 border-indigo-500' : 'text-gray-400 hover:text-white'}`}>Unstake/Restake</button>
                    <button onClick={() => setSubTab('activities')} className={`px-4 py-2 font-medium ${subTab === 'activities' ? 'text-white border-b-2 border-indigo-500' : 'text-gray-400 hover:text-white'}`}>Activities</button>
                </div>

                <div className="mt-6">
                    {subTab === 'delegations' && (
                         <div className="overflow-x-auto">
                            <div className="min-w-[700px] space-y-2">
                                <div className="grid grid-cols-12 gap-4 px-4 py-2 text-xs font-semibold text-gray-400 uppercase">
                                    <div className="col-span-4">Validator</div>
                                    <div className="col-span-3 text-right">Staked</div>
                                    <div className="col-span-3 text-right">Claimable</div>
                                    <div className="col-span-2"></div>
                                </div>
                                {MY_DELEGATIONS.map(delegation => {
                                    const validator = VALIDATORS.find(v => v.name === delegation.validatorName);
                                    return (
                                    <div key={delegation.validatorName} className="grid grid-cols-12 gap-4 items-center bg-gray-900/40 p-4 rounded-lg">
                                        <div className="col-span-4 font-semibold text-white hover:text-indigo-400 cursor-pointer" onClick={() => onSelectValidator(validator)}>{delegation.validatorName}</div>
                                        <div className="col-span-3 text-right font-mono text-white">{delegation.stakedAmount.toLocaleString()} LUME</div>
                                        <div className="col-span-3 text-right font-mono text-teal-400">{delegation.claimableRewards.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} LUME</div>
                                        <div className="col-span-2 flex justify-end">
                                            {delegation.claimableRewards > 0 && <Button variant="secondary" className="!py-1.5 !px-4 text-sm">Claim</Button>}
                                        </div>
                                    </div>
                                    )
                                })}
                            </div>
                         </div>
                    )}
                    {subTab === 'unstake' && <UnstakingDelegations onSelectValidator={onSelectValidator}/>}
                    {subTab === 'activities' && <StakingActivities />}
                </div>
            </div>
        </Card>
    );
};

const UnstakingDelegations = ({ onSelectValidator }) => {
    const TimeRemaining = ({ completionTime }) => {
        const [remaining, setRemaining] = useState('');
        useEffect(() => {
            const calculateRemaining = () => {
                const now = new Date();
                const completion = new Date(completionTime);
                const diff = completion - now;

                if (diff <= 0) { setRemaining('Completed'); return; }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                setRemaining(`${days}d ${hours}h ${minutes}m`);
            };
            calculateRemaining();
            const interval = setInterval(calculateRemaining, 60000);
            return () => clearInterval(interval);
        }, [completionTime]);
        return <span>{remaining}</span>;
    };

    return (
        <div className="overflow-x-auto">
            <div className="min-w-[700px] space-y-2">
                <div className="grid grid-cols-12 gap-4 px-4 py-2 text-xs font-semibold text-gray-400 uppercase">
                    <div className="col-span-4">Validator</div>
                    <div className="col-span-3 text-right">Amount</div>
                    <div className="col-span-2 text-center">Status</div>
                    <div className="col-span-3 text-right">Completion Time</div>
                </div>
                {MY_UNSTAKING_DELEGATIONS.map((delegation, i) => {
                    const validator = VALIDATORS.find(v => v.name === delegation.validatorName);
                    return (
                        <div key={i} className="grid grid-cols-12 gap-4 items-center bg-gray-900/40 p-4 rounded-lg">
                            <div className="col-span-4 font-semibold text-white hover:text-indigo-400 cursor-pointer" onClick={() => onSelectValidator(validator)}>{delegation.validatorName}</div>
                            <div className="col-span-3 text-right font-mono text-white">{delegation.amount.toLocaleString()} LUME</div>
                            <div className="col-span-2 text-center text-amber-400 font-medium">{delegation.status}</div>
                            <div className="col-span-3 text-right font-mono text-gray-300">
                                <TimeRemaining completionTime={delegation.completionTime} />
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

const StakingActivities = () => {
    return (
        <div className="overflow-x-auto">
            <div className="min-w-[750px] space-y-2">
                <div className="grid grid-cols-12 gap-4 px-4 py-2 text-xs font-semibold text-gray-400 uppercase">
                    <div className="col-span-3">TX Hash</div>
                    <div className="col-span-1">Result</div>
                    <div className="col-span-2">Event Type</div>
                    <div className="col-span-2">Block</div>
                    <div className="col-span-2 text-right">Amount</div>
                    <div className="col-span-2 text-right">Time</div>
                </div>
                {MY_STAKING_ACTIVITIES.map((tx, i) => (
                    <div key={i} className="grid grid-cols-12 gap-4 items-center bg-gray-900/40 p-4 rounded-lg text-sm">
                        <div className="col-span-3">
                            <a href="#" className="font-mono text-indigo-400 hover:underline truncate flex items-center gap-1.5">{`${tx.txHash.substring(0,6)}...${tx.txHash.substring(tx.txHash.length - 6)}`}<ArrowUpRight className="w-3 h-3"/></a>
                        </div>
                         <div className="col-span-1">
                            {tx.result === 'Success' 
                                ? <span className="flex items-center gap-1.5 text-green-400"><CheckCircle className="w-4 h-4"/> Success</span>
                                : <span className="flex items-center gap-1.5 text-red-400"><XCircle className="w-4 h-4"/> Failed</span>
                            }
                        </div>
                        <div className="col-span-2 font-medium text-white">{tx.eventType}</div>
                        <div className="col-span-2 text-gray-300">{tx.block}</div>
                        <div className="col-span-2 text-right font-mono text-white">{tx.amount.toLocaleString()} LUME</div>
                        <div className="col-span-2 text-right text-gray-400">{tx.time}</div>
                    </div>
                ))}
            </div>
        </div>
    );
};

const AllValidators = ({ onSelectValidator }) => {
    const [activeTab, setActiveTab] = useState('active');
    const [searchQuery, setSearchQuery] = useState('');
    const [calculatorAmount, setCalculatorAmount] = useState('');
    
    const filteredValidators = useMemo(() => {
        return VALIDATORS
            .filter(v => v.status === activeTab)
            .filter(v => v.name.toLowerCase().includes(searchQuery.toLowerCase()));
    }, [activeTab, searchQuery]);

    const calculateRewards = (amount, period) => {
        if (!amount || amount <= 0) return 0;
        const dailyRate = STAKING_DATA.apy / 100 / 365;
        return amount * dailyRate * period;
    };
    
    const rewardPeriods = [ { label: '1 Day', days: 1 }, { label: '7 Days', days: 7 }, { label: '30 Days', days: 30 }, { label: '365 Days', days: 365 } ];
    const UptimeIndicator = ({ uptime }) => {
        const color = uptime > 99 ? 'bg-teal-500' : uptime > 95 ? 'bg-amber-500' : 'bg-red-500';
        return (<div className="flex items-center gap-2"><div className="w-full bg-gray-700 rounded-full h-2"><div className={`${color} h-2 rounded-full`} style={{ width: `${uptime}%` }}></div></div><span className="text-sm font-medium text-gray-300 w-14 text-right">{uptime.toFixed(2)}%</span></div>);
    };

    return (
        <div className="space-y-8">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <Card>
                    <h3 className="font-semibold text-gray-400">Total LUME Staked</h3>
                    <p className="text-3xl sm:text-4xl font-bold text-white mt-2">{(STAKING_DATA.totalStaked / 1_000_000).toFixed(2)}M LUME</p>
                </Card>
                <Card>
                    <h3 className="font-semibold text-gray-400">Current Staking APR</h3>
                    <p className="text-3xl sm:text-4xl font-bold text-teal-400 mt-2">{STAKING_DATA.apy}%</p>
                </Card>
            </div>
            
            <Card>
                <div className="flex flex-col lg:flex-row gap-8">
                    <div className="flex-1">
                        <h2 className="text-xl font-semibold text-white flex items-center gap-2"><Calculator className="w-6 h-6 text-indigo-400"/>Rewards Calculator</h2>
                        <p className="text-gray-400 text-sm mt-1">Estimate your potential earnings from staking LUME.</p>
                        <div className="mt-6">
                            <label className="text-sm font-medium text-gray-300 mb-2 block">Amount to Stake</label>
                            <div className="relative"><input type="number" placeholder="0.00" value={calculatorAmount} onChange={(e) => setCalculatorAmount(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-700 rounded-lg p-3 text-white focus:border-indigo-500 focus:ring-0 transition text-lg" /><span className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-semibold">LUME</span></div>
                        </div>
                    </div>
                    <div className="flex-1 bg-gray-900/50 p-6 rounded-xl">
                        <h3 className="font-semibold text-white">Estimated Rewards</h3>
                        <div className="grid grid-cols-2 gap-x-6 gap-y-4 mt-4">{rewardPeriods.map(period => {
                            const rewards = calculateRewards(parseFloat(calculatorAmount), period.days);
                            return (<div key={period.label}><p className="text-sm text-gray-400">{period.label}</p><p className="text-lg font-bold text-teal-400">{rewards > 0 ? `+${rewards.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 })}` : '0.00'}<span className="text-sm font-medium text-gray-500 ml-1">LUME</span></p></div>);
                        })}</div>
                        <p className="text-xs text-gray-500 mt-4">* All calculations are estimates based on the current APR and are subject to change.</p>
                    </div>
                </div>
            </Card>

            <Card>
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div><h2 className="text-xl font-semibold text-white">All Validators</h2><p className="text-gray-400 text-sm mt-1">Delegate your stake to a validator to earn rewards.</p></div>
                    <div className="relative w-full md:w-auto"><input type="text" placeholder="Search validator..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full md:w-64 bg-gray-900 border-2 border-gray-700 rounded-lg py-2 pl-4 pr-10 text-white focus:border-indigo-500 focus:ring-0 transition" /><Search className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" /></div>
                </div>
                <div className="flex border-b border-gray-700 mb-1">
                    <button onClick={() => {setActiveTab('active'); setSearchQuery('')}} className={`px-4 py-2 font-medium transition-colors ${activeTab === 'active' ? 'text-white border-b-2 border-indigo-500' : 'text-gray-400 hover:text-white'}`}>Active ({VALIDATORS.filter(v => v.status === 'active').length})</button>
                    <button onClick={() => {setActiveTab('inactive'); setSearchQuery('')}} className={`px-4 py-2 font-medium transition-colors ${activeTab === 'inactive' ? 'text-white border-b-2 border-indigo-500' : 'text-gray-400 hover:text-white'}`}>Inactive ({VALIDATORS.filter(v => v.status === 'inactive').length})</button>
                </div>
                <div className="overflow-x-auto">
                    <div className="min-w-[700px]">
                        <div className="hidden md:grid grid-cols-12 gap-4 px-4 py-3 text-sm font-semibold text-gray-400"><div className="col-span-3">Validator</div><div className="col-span-2 text-right">Staked Amount</div><div className="col-span-2 text-right">Commission</div><div className="col-span-2 text-right">Voting Power</div><div className="col-span-2">Uptime</div><div className="col-span-1"></div></div>
                        <div className="space-y-2 mt-2">{filteredValidators.length > 0 ? filteredValidators.map(validator => (
                            <div key={validator.name} onClick={() => onSelectValidator(validator)} className="grid grid-cols-1 md:grid-cols-12 gap-x-4 gap-y-2 items-center bg-gray-900/40 hover:bg-gray-800/60 p-4 rounded-lg transition-colors cursor-pointer">
                                <div className="md:col-span-3 text-lg md:text-base font-semibold text-white">{validator.name}</div>
                                <div className="flex justify-between items-center md:block md:col-span-2 md:text-right"><span className="md:hidden text-gray-400 text-sm">Staked Amount</span><span className="font-mono">{validator.stakedAmount.toLocaleString()} LUME</span></div>
                                <div className="flex justify-between items-center md:block md:col-span-2 md:text-right"><span className="md:hidden text-gray-400 text-sm">Commission</span><span className="font-mono">{validator.commission.toFixed(1)}%</span></div>
                                <div className="flex justify-between items-center md:block md:col-span-2 md:text-right"><span className="md:hidden text-gray-400 text-sm">Voting Power</span><span className="font-mono">{validator.votingPower.toFixed(2)}%</span></div>
                                <div className="flex justify-between items-center md:block md:col-span-2"><span className="md:hidden text-gray-400 text-sm">Uptime</span><UptimeIndicator uptime={validator.uptime} /></div>
                                <div className="md:col-span-1 flex justify-end mt-2 md:mt-0"><Button variant="secondary" className="!px-4 !py-2 text-sm w-full md:w-auto">Delegate</Button></div>
                            </div>
                        )) : (<div className="text-center py-12 text-gray-500"><p className="text-lg">No validators found matching your criteria.</p></div>)}</div>
                    </div>
                </div>
            </Card>
        </div>
    );
};

const ValidatorDetail = ({ validator, onBack }) => {
    const [last100Blocks, setLast100Blocks] = useState([]);
    
    useEffect(() => {
        const generateInitialBlocks = () => {
            const blockTypes = ['signed', 'signed', 'signed', 'proposed', 'missed'];
            let blocks = Array.from({length: 100}, () => blockTypes[Math.floor(Math.random() * (validator.uptime > 99 ? 4 : 5))]);
            setLast100Blocks(blocks);
        }
        generateInitialBlocks();
        const interval = setInterval(() => {
            setLast100Blocks(prev => [...prev.slice(1), ['signed', 'signed', 'signed', 'proposed', 'missed'][Math.floor(Math.random() * (validator.uptime > 99 ? 4 : 5))]]);
        }, 2000);
        return () => clearInterval(interval);
    }, [validator.uptime]);

    const blockStats = useMemo(() => last100Blocks.reduce((acc, block) => ({...acc, [block]: (acc[block] || 0) + 1 }), { signed: 0, proposed: 0, missed: 0 }), [last100Blocks]);

    return (
        <div className="space-y-8">
            <div>
                <button onClick={onBack} className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4"><ChevronLeft className="w-5 h-5"/>Back to Validators</button>
                <div className="flex flex-col md:flex-row justify-between md:items-center gap-4"><h1 className="text-3xl md:text-4xl font-bold text-white">{validator.name}</h1><Button>Delegate</Button></div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div className="lg:col-span-2 space-y-8">
                    <Card><h2 className="text-xl font-semibold text-white mb-3">Description</h2><p className="text-gray-300 leading-relaxed">{validator.details.description}</p></Card>
                    <Card>
                        <h2 className="text-xl font-semibold text-white mb-4">Last 100 Blocks</h2>
                        <div className="flex items-center gap-6 text-sm mb-4">
                            <span className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-green-500"></div>Signed: {blockStats.signed}</span>
                            <span className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-sky-500"></div>Proposed: {blockStats.proposed}</span>
                            <span className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-red-500"></div>Missed: {blockStats.missed}</span>
                        </div>
                        <div className="grid grid-cols-10 md:grid-cols-20 gap-1.5">{last100Blocks.map((block, index) => (<div key={index} className={`h-6 rounded ${block === 'signed' ? 'bg-green-500' : block === 'proposed' ? 'bg-sky-500' : 'bg-red-500'} transition-colors duration-500`} title={`Block ${index+1}: ${block}`}></div>))}</div>
                    </Card>
                </div>
                <div className="lg:col-span-1 space-y-8">
                    <Card>
                         <h2 className="text-xl font-semibold text-white mb-4">Details</h2>
                         <div className="space-y-4 text-sm">
                            <div className="flex justify-between items-center"><span className="text-gray-400">Website</span><a href={validator.details.website} target="_blank" rel="noopener noreferrer" className="text-indigo-400 hover:underline flex items-center gap-1">{validator.details.website.replace('https://www.', '')} <ArrowUpRight className="w-4 h-4"/></a></div>
                            <div className="flex justify-between items-center"><span className="text-gray-400">Security Contact</span><a href={`mailto:${validator.details.securityContact}`} className="text-indigo-400 hover:underline">{validator.details.securityContact}</a></div>
                             <div className="space-y-2">
                                <span className="text-gray-400">Wallet Address</span>
                                <div className="flex items-center gap-2 bg-gray-900/50 p-2 rounded-md"><span className="font-mono text-xs text-gray-300 truncate">{validator.details.address}</span><button onClick={() => navigator.clipboard.writeText(validator.details.address)} className="text-gray-400 hover:text-white"><Copy className="w-4 h-4"/></button></div>
                            </div>
                         </div>
                    </Card>
                    <Card>
                        <h2 className="text-xl font-semibold text-white mb-4">Statistics</h2>
                         <div className="space-y-4 text-sm">
                            <div className="flex justify-between"><span className="text-gray-400">Total Staked</span><span className="font-semibold text-white">{validator.stakedAmount.toLocaleString()} LUME</span></div>
                            <div className="flex justify-between"><span className="text-gray-400">Commission</span><span className="font-semibold text-white">{validator.commission}%</span></div>
                            <div className="flex justify-between"><span className="text-gray-400">Voting Power</span><span className="font-semibold text-white">{validator.votingPower}%</span></div>
                            <div className="flex justify-between"><span className="text-gray-400">Uptime</span><span className={`font-semibold ${validator.uptime > 99 ? 'text-teal-400' : 'text-amber-400'}`}>{validator.uptime}%</span></div>
                            <div className="flex justify-between"><span className="text-gray-400">Status</span><span className={`font-semibold ${validator.details.status === 'Bonded' ? 'text-green-400' : 'text-red-400'}`}>{validator.details.status}</span></div>
                         </div>
                    </Card>
                </div>
            </div>
            <Card>
                <h2 className="text-xl font-semibold text-white mb-4">Delegators ({validator.details.delegators.length})</h2>
                <div className="overflow-x-auto">
                    <div className="min-w-[500px] space-y-2">
                         <div className="grid grid-cols-10 gap-4 px-4 py-3 text-sm font-semibold text-gray-400"><div className="col-span-5">Delegator Address</div><div className="col-span-2 text-right">Stake Share</div><div className="col-span-3 text-right">Amount</div></div>
                         {validator.details.delegators.map((d, i) => (<div key={i} className="grid grid-cols-10 gap-4 p-3 bg-gray-900/40 rounded-lg text-sm"><div className="col-span-5 font-mono text-gray-300 truncate">{d.address}</div><div className="col-span-2 text-right text-indigo-400">{((d.stakedAmount / validator.stakedAmount) * 100).toFixed(2)}%</div><div className="col-span-3 text-right font-mono text-white">{d.stakedAmount.toLocaleString(undefined, {maximumFractionDigits: 2})} LUME</div></div>))}
                    </div>
                </div>
            </Card>
        </div>
    )
};

const Governance = ({ onSelectProposal, onBack }) => {
    const [selectedProposal, setSelectedProposal] = useState(null);
    const [activeFilter, setActiveFilter] = useState('All');
    const [searchQuery, setSearchQuery] = useState('');

    const filters = ['All', 'Expedited', 'Deposit', 'Voting', 'Passed', 'Rejected'];

    const proposalCounts = useMemo(() => ({
        All: GOVERNANCE_PROPOSALS.length,
        Expedited: GOVERNANCE_PROPOSALS.filter(p => p.status === 'Expedited').length,
        Deposit: GOVERNANCE_PROPOSALS.filter(p => p.status === 'Deposit').length,
        Voting: GOVERNANCE_PROPOSALS.filter(p => p.status === 'Voting').length,
        Passed: GOVERNANCE_PROPOSALS.filter(p => p.status === 'Passed').length,
        Rejected: GOVERNANCE_PROPOSALS.filter(p => p.status === 'Rejected').length,
    }), []);

    const filteredProposals = useMemo(() => {
        return GOVERNANCE_PROPOSALS
            .filter(p => {
                if (activeFilter === 'All') return true;
                return p.status === activeFilter;
            })
            .filter(p => 
                p.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                p.id.toLowerCase().includes(searchQuery.toLowerCase())
            );
    }, [activeFilter, searchQuery]);
    
    if (selectedProposal) {
        return <ProposalDetail proposal={selectedProposal} onBack={() => setSelectedProposal(null)} />;
    }

    return (
        <div className="space-y-8">
             <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h1 className="text-3xl font-bold text-white">Governance</h1>
                <Button>Create Proposal</Button>
            </div>
             <div className="grid grid-cols-2 md:grid-cols-4 gap-8">
                <Card><div className="flex items-center gap-4"><List className="w-8 h-8 text-indigo-400"/><div className="flex flex-col"><p className="text-sm text-gray-400">Total Proposals</p><p className="text-2xl font-bold text-white">{GOVERNANCE_PROPOSALS.length}</p></div></div></Card>
                <Card><div className="flex items-center gap-4"><BadgeCheck className="w-8 h-8 text-green-400"/><div className="flex flex-col"><p className="text-sm text-gray-400">Passed</p><p className="text-2xl font-bold text-white">{GOVERNANCE_PROPOSALS.filter(p => p.status === 'Passed').length}</p></div></div></Card>
                <Card><div className="flex items-center gap-4"><Hourglass className="w-8 h-8 text-amber-400"/><div className="flex flex-col"><p className="text-sm text-gray-400">Voting Period</p><p className="text-2xl font-bold text-white">{GOVERNANCE_STATS.votingPeriod}</p></div></div></Card>
                <Card><div className="flex items-center gap-4"><LandmarkIcon className="w-8 h-8 text-sky-400"/><div className="flex flex-col"><p className="text-sm text-gray-400">Deposit Required</p><p className="text-2xl font-bold text-white">{GOVERNANCE_STATS.depositRequired} LUME</p></div></div></Card>
            </div>
            <Card>
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div className="flex items-center border border-gray-700 rounded-lg p-1 bg-gray-900/50">
                        {filters.map(filter => (
                            <button key={filter} onClick={() => setActiveFilter(filter)} className={`px-3 py-1.5 rounded-md text-sm font-semibold transition-colors ${activeFilter === filter ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-gray-700'}`}>
                                {filter} ({proposalCounts[filter]})
                            </button>
                        ))}
                    </div>
                    <div className="relative w-full md:w-auto">
                        <input type="text" placeholder="Search proposals..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full md:w-64 bg-gray-900 border-2 border-gray-700 rounded-lg py-2 pl-4 pr-10 text-white focus:border-indigo-500 focus:ring-0 transition" />
                        <Search className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {filteredProposals.length > 0 ? filteredProposals.map(p => (
                        <ProposalCard key={p.id} proposal={p} onSelect={() => setSelectedProposal(p)} />
                    )) : (<div className="text-center py-12 text-gray-500 col-span-full"><p className="text-lg font-semibold">No proposals found.</p><p>Try adjusting your search or filter.</p></div>)}
                </div>
            </Card>
        </div>
    );
};

const ProposalCard = ({ proposal, onSelect }) => {
    const VoteBar = ({ votes }) => {
        const total = votes.for + votes.no + votes.abstain + votes.noWithVeto;
        if (total === 0) return <div className="w-full bg-gray-700 rounded-full h-2.5 my-2"></div>;
        const forPercent = (votes.for / total * 100);
        const againstPercent = (votes.no / total * 100);
        
        return (
            <div className="w-full bg-gray-700 rounded-full h-2.5 flex my-2 overflow-hidden">
                <div className="bg-teal-500 h-2.5" style={{width: `${forPercent}%`}} title={`For: ${forPercent.toFixed(1)}%`}></div>
                <div className="bg-red-500 h-2.5" style={{width: `${againstPercent}%`}} title={`No: ${againstPercent.toFixed(1)}%`}></div>
            </div>
        );
    };

    return (
        <div onClick={onSelect} className="bg-gray-800/50 rounded-2xl p-0 overflow-hidden flex flex-col hover:border-indigo-500/50 border border-transparent cursor-pointer transition-all duration-300">
            <div className="p-6 flex-1">
                <div className="flex flex-col sm:flex-row justify-between sm:items-start gap-4 mb-4">
                    <div className="flex-grow">
                        <p className="text-gray-400 text-sm">{proposal.id}</p>
                        <h3 className="text-xl font-semibold text-white mt-1">{proposal.title}</h3>
                    </div>
                    <StatusPill status={proposal.status}/>
                </div>
                <p className="text-gray-300 mb-4 flex-1 line-clamp-2">{proposal.description}</p>
                <VoteBar votes={proposal.votes} />
                <div className="flex justify-between text-sm text-gray-400">
                    <span><span className="text-teal-400">For</span>: {(proposal.votes.for / 1_000_000).toFixed(1)}M</span>
                    <span><span className="text-red-400">No</span>: {(proposal.votes.no / 1_000_000).toFixed(1)}M</span>
                    <span><span className="text-gray-500">Abstain</span>: {(proposal.votes.abstain / 1_000_000).toFixed(1)}M</span>
                </div>
            </div>
            { (proposal.status === 'Voting' || proposal.status === 'Expedited') && (<div className="bg-gray-900/50 p-4 flex justify-end items-center gap-3"><p className="text-sm text-gray-400">Voting ends in {Math.round((new Date(proposal.endDate) - new Date()) / (1000 * 60 * 60 * 24))} days</p></div>)}
            { proposal.status === 'Deposit' && (<div className="bg-gray-900/50 p-4 flex justify-end items-center gap-3"><Button>Deposit</Button></div>)}
        </div>
    );
};

const ProposalDetail = ({ proposal, onBack }) => {

    const totalVotes = proposal.votes.for + proposal.votes.no + proposal.votes.abstain + proposal.votes.noWithVeto;
    const participation = (totalVotes / GOVERNANCE_STATS.totalVotingPower) * 100;
    const quorumReached = participation >= GOVERNANCE_STATS.quorum;

    const yesPercent = totalVotes > 0 ? (proposal.votes.for / (proposal.votes.for + proposal.votes.no)) * 100 : 0;
    const noPercent = totalVotes > 0 ? (proposal.votes.no / (proposal.votes.for + proposal.votes.no)) * 100 : 0;
    
    const voteData = [
        { name: 'Yes', value: proposal.votes.for, color: '#2dd4bf' },
        { name: 'No', value: proposal.votes.no, color: '#f87171' },
        { name: 'No with Veto', value: proposal.votes.noWithVeto, color: '#fb923c' },
        { name: 'Abstain', value: proposal.votes.abstain, color: '#9ca3af' },
    ];
    
    const [voterSearch, setVoterSearch] = useState('');
    const filteredVoters = useMemo(() => {
        return proposal.voters.filter(v => v.address.toLowerCase().includes(voterSearch.toLowerCase()));
    }, [voterSearch, proposal.voters]);


    const TimeRemaining = ({ startTime, endTime }) => {
        const [remaining, setRemaining] = useState({days: 0, hours: 0, minutes: 0, total: 0});
        const [progress, setProgress] = useState(0);

        useEffect(() => {
            const calculate = () => {
                const now = new Date().getTime();
                const start = new Date(startTime).getTime();
                const end = new Date(endTime).getTime();
                const totalDuration = end - start;

                let currentProgress = 0;
                if(now > start && totalDuration > 0) {
                     const elapsed = now - start;
                     currentProgress = (elapsed / totalDuration) * 100;
                } else if (now >= end) {
                    currentProgress = 100;
                }
                
                setProgress(Math.min(currentProgress, 100));

                const totalRemaining = end - now;
                 if (totalRemaining <= 0) {
                    setRemaining({days: 0, hours: 0, minutes: 0, total: 0});
                    return;
                }
                const days = Math.floor(totalRemaining / (1000 * 60 * 60 * 24));
                const hours = Math.floor((totalRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((totalRemaining % (1000 * 60 * 60)) / (1000 * 60));
                setRemaining({days, hours, minutes, total: totalRemaining});
            };

            calculate();
            const interval = setInterval(calculate, 60000);
            return () => clearInterval(interval);
        }, [startTime, endTime]);
        
        return (
             <div className="space-y-2">
                <div className="text-right text-gray-300">
                   {remaining.total > 0 ? `${remaining.days}d ${remaining.hours}h ${remaining.minutes}m left` : "Voting ended"}
                </div>
                 <div className="w-full bg-gray-700 rounded-full h-2.5 overflow-hidden">
                    <div className="bg-indigo-500 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div>
                </div>
                <div className="text-xs text-gray-500 text-right">
                    Ends on {new Date(endTime).toLocaleString(undefined, { month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' })}
                </div>
            </div>
        );
    };
    
    const VoterTypePill = ({type}) => {
        const styles = {
            'For': 'bg-teal-500/20 text-teal-300',
            'No': 'bg-red-500/20 text-red-300',
            'Abstain': 'bg-gray-500/20 text-gray-300',
            'No with Veto': 'bg-orange-500/20 text-orange-300'
        };
        return <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${styles[type]}`}>{type}</span>;
    }

    return(
        <div className="space-y-8">
             <div>
                <button onClick={onBack} className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4"><ChevronLeft className="w-5 h-5"/>Back to Proposals</button>
                <div className="flex flex-col md:flex-row justify-between md:items-start gap-4">
                    <h1 className="text-3xl md:text-4xl font-bold text-white">{proposal.id}: {proposal.title}</h1>
                    <StatusPill status={proposal.status} />
                </div>
            </div>
            <Card>
                <h2 className="text-2xl font-semibold text-white mb-4">Description</h2>
                <p className="text-gray-300 leading-relaxed">{proposal.description}</p>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mt-6 border-t border-gray-700 pt-6">
                    <div><p className="text-sm text-gray-400">Proposal Type</p><p className="font-semibold text-white">{proposal.type}</p></div>
                    <div><p className="text-sm text-gray-400">Proposed On</p><p className="font-semibold text-white">{new Date(proposal.proposeDate).toLocaleDateString()}</p></div>
                    <div><p className="text-sm text-gray-400">Voting End</p><p className="font-semibold text-white">{new Date(proposal.endDate).toLocaleDateString()}</p></div>
                    <div><p className="text-sm text-gray-400">Deposit</p><p className="font-semibold text-white">{proposal.deposit} LUME</p></div>
                </div>
            </Card>

            <Card>
                 <h2 className="text-2xl font-semibold text-white mb-4">Results</h2>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="space-y-4">
                        <h3 className="font-semibold text-white">Quorum</h3>
                        <div className="w-full bg-gray-700 rounded-full h-2.5">
                           <div className="bg-indigo-500 h-2.5 rounded-full" style={{ width: `${participation}%` }}></div>
                        </div>
                        <div className="flex justify-between text-sm">
                            <span className="text-gray-300">{participation.toFixed(2)}% Participation</span>
                             <span className={quorumReached ? 'text-green-400' : 'text-red-400'}>
                                {quorumReached ? 'Quorum Reached' : 'Quorum Not Reached'}
                            </span>
                        </div>
                    </div>
                     <div className="space-y-4">
                        <h3 className="font-semibold text-white">Threshold</h3>
                        <div className="w-full flex rounded-full overflow-hidden h-2.5 bg-gray-700">
                           <div className="bg-teal-500" style={{ width: `${yesPercent}%` }}></div>
                           <div className="bg-red-500" style={{ width: `${noPercent}%` }}></div>
                        </div>
                        <div className="flex justify-between text-sm">
                             <span className="text-teal-400">{yesPercent.toFixed(2)}% Yes</span>
                             <span className="text-red-400">{noPercent.toFixed(2)}% No</span>
                        </div>
                    </div>
                     <div className="md:col-span-2">
                        <h3 className="font-semibold text-white mb-4">Voting Period</h3>
                        <TimeRemaining startTime={proposal.proposeDate} endTime={proposal.endDate}/>
                    </div>
                 </div>
            </Card>
            
            <Card>
                <h2 className="text-2xl font-semibold text-white mb-4">Votes & Voters</h2>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div className="flex flex-col items-center">
                        <div className="w-48 h-48">
                            <ResponsiveContainer>
                                <PieChart>
                                    <Pie data={voteData} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={80} fill="#8884d8">
                                        {voteData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                                    </Pie>
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="w-full mt-4 space-y-2">
                            {voteData.map(entry => (
                                <div key={entry.name} className="flex justify-between items-center text-sm p-2 bg-gray-900/50 rounded-md">
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full" style={{backgroundColor: entry.color}}></div>
                                        <span className="text-gray-300">{entry.name}</span>
                                    </div>
                                    <span className="font-semibold text-white">{entry.value.toLocaleString()} LUME ({totalVotes > 0 ? (entry.value / totalVotes * 100).toFixed(2) : 0}%)</span>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div>
                        <div className="relative mb-4">
                             <input type="text" placeholder="Search voters..." value={voterSearch} onChange={e => setVoterSearch(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-700 rounded-lg py-2 pl-4 pr-10 text-white focus:border-indigo-500 focus:ring-0 transition" />
                             <Search className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
                        </div>
                        <div className="space-y-2 h-96 overflow-y-auto pr-2">
                            {filteredVoters.map((voter, index) => (
                                <div key={index} className="flex justify-between items-center p-3 bg-gray-900/50 rounded-md">
                                    <span className="font-mono text-sm text-gray-300 truncate">{`${voter.address.substring(0,10)}...${voter.address.substring(voter.address.length - 10)}`}</span>
                                    <VoterTypePill type={voter.vote}/>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </Card>
            
        </div>
    )
};


const PlaceholderPage = ({ title, icon: Icon, children }) => (
    <Card className="text-center flex flex-col items-center justify-center h-[60vh]">
        <div className="bg-gray-700/50 p-4 rounded-full mb-6">
            <Icon className="w-12 h-12 text-indigo-400" />
        </div>
        <h1 className="text-4xl font-bold text-white">{title}</h1>
        <p className="text-gray-400 mt-2 max-w-md">{children}</p>
    </Card>
);

const UnconnectedView = () => (
    <div className="text-center">
        <div className="max-w-md mx-auto">
          <Layers className="w-24 h-24 text-indigo-500/50 mx-auto" />
          <h1 className="text-4xl font-bold text-white mt-4">Welcome to the Lumera Hub</h1>
          <p className="text-lg text-gray-400 mt-2">
            Connect your wallet to manage assets, participate in governance, and access the full suite of Lumera services.
          </p>
        </div>
    </div>
);

const Cascade = () => {
    const [myFiles, setMyFiles] = useState([
        { name: 'project-lumera-whitepaper.pdf', size: 5242880, lastModified: '2025-07-10T10:00:00Z', type: 'pdf', txId: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`},
        { name: 'brand-assets.zip', size: 157286400, lastModified: '2025-07-09T15:30:00Z', type: 'zip', txId: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`},
        { name: 'dashboard-preview.png', size: 1887436, lastModified: '2025-07-08T11:20:00Z', type: 'image', txId: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`},
        { name: 'meeting-notes-q2.docx', size: 34560, lastModified: '2025-07-07T18:00:00Z', type: 'docx', txId: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`},

    ]);
    const [isDragging, setIsDragging] = useState(false);
    const [filesToUpload, setFilesToUpload] = useState([]);
    const [uploadCost, setUploadCost] = useState(0);
    const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
    const [fileSearch, setFileSearch] = useState('');
    const [previewFile, setPreviewFile] = useState(null);
    const [selectedFiles, setSelectedFiles] = useState([]);
    const [fileTypeFilter, setFileTypeFilter] = useState('All');

    const fileInputRef = useRef(null);
    const storageUsed = useMemo(() => myFiles.reduce((acc, file) => acc + file.size, 0), [myFiles]);
    const totalNetworkStorage = 25 * 1024 * 1024 * 1024 * 1024; // 25 PB
    const COST_PER_MB = 0.05;

    const getSimplifiedType = (type) => {
        if (type.startsWith('image')) return 'Image';
        if (type.startsWith('video')) return 'Video';
        if (type === 'pdf') return 'PDF';
        if (['zip', 'x-zip-compressed', 'rar', '7z'].includes(type)) return 'Archive';
        return 'Other';
    }
    
    const fileCounts = useMemo(() => {
        const counts = {
            All: myFiles.length,
            Image: 0,
            PDF: 0,
            Video: 0,
            Archive: 0,
            Other: 0,
        };
        myFiles.forEach(file => {
            const simpleType = getSimplifiedType(file.type);
            if (counts.hasOwnProperty(simpleType)) {
                counts[simpleType]++;
            } else {
                counts.Other++;
            }
        });
        return counts;
    }, [myFiles]);


    const filteredFiles = useMemo(() => {
        return myFiles
            .filter(file => file.name.toLowerCase().includes(fileSearch.toLowerCase()))
            .filter(file => fileTypeFilter === 'All' || getSimplifiedType(file.type) === fileTypeFilter);
    }, [myFiles, fileSearch, fileTypeFilter]);
    
    const handleSelectFile = (fileName) => {
        setSelectedFiles(prev => prev.includes(fileName) ? prev.filter(f => f !== fileName) : [...prev, fileName]);
    };
    
    const handleSelectAll = (e) => {
        if (e.target.checked) {
            setSelectedFiles(filteredFiles.map(f => f.name));
        } else {
            setSelectedFiles([]);
        }
    };


    const formatBytes = (bytes, decimals = 2) => {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    };

    const getFileIcon = (type) => {
        const simpleType = getSimplifiedType(type);
        switch (simpleType) {
            case 'Image': return <ImageIcon className="w-6 h-6 text-blue-400" />;
            case 'Video': return <Video className="w-6 h-6 text-purple-400" />;
            case 'PDF': return <FileText className="w-6 h-6 text-red-400" />;
            case 'Archive': return <FileArchive className="w-6 h-6 text-yellow-400" />;
            default: return <FileIcon className="w-6 h-6 text-gray-400" />;
        }
    };
    
    const handleFiles = (files) => {
        const fileList = Array.from(files);
        const totalSize = fileList.reduce((acc, file) => acc + file.size, 0);
        const cost = (totalSize / (1024 * 1024)) * COST_PER_MB;
        
        setFilesToUpload(fileList);
        setUploadCost(cost);
        setIsConfirmModalOpen(true);
    };

    const handleConfirmUpload = () => {
        const newFiles = filesToUpload.map(file => ({
            name: file.name,
            size: file.size,
            lastModified: new Date().toISOString(),
            type: file.type.split('/')[1] || file.type.split('/')[0],
            txId: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`
        }));
        setMyFiles(prevFiles => [...newFiles, ...prevFiles]);
        setIsConfirmModalOpen(false);
        setFilesToUpload([]);
        setUploadCost(0);
    };

    const handleDragEnter = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(true); };
    const handleDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); };
    const handleDragOver = (e) => { e.preventDefault(); e.stopPropagation(); };
    const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handleFiles(e.dataTransfer.files);
            e.dataTransfer.clearData();
        }
    };
    
    const handleFileSelect = (e) => {
        if (e.target.files && e.target.files.length > 0) {
            handleFiles(e.target.files);
        }
    };
    
    const handleRowClick = (file) => {
        if(getSimplifiedType(file.type) === 'Image') {
            setPreviewFile(file);
        }
    };

    const FilePreviewModal = () => (
        <Transition show={!!previewFile} as={Fragment}>
             <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50" onClick={() => setPreviewFile(null)}>
                <Transition.Child
                    as={Fragment}
                    enter="ease-out duration-300"
                    enterFrom="opacity-0 scale-95"
                    enterTo="opacity-100 scale-100"
                    leave="ease-in duration-200"
                    leaveFrom="opacity-100 scale-100"
                    leaveTo="opacity-0 scale-95"
                >
                    <div className="relative max-w-4xl max-h-[80vh] w-full" onClick={(e) => e.stopPropagation()}>
                         <button onClick={() => setPreviewFile(null)} className="absolute -top-10 right-0 text-white hover:text-gray-400"><X className="w-8 h-8"/></button>
                         <img src={`https://placehold.co/1200x800/1f2937/7dd3fc?text=${previewFile?.name}`} alt={previewFile?.name} className="w-full h-full object-contain rounded-lg"/>
                         <p className="text-center text-white mt-2">{previewFile?.name}</p>
                    </div>
                 </Transition.Child>
            </div>
        </Transition>
    );

    return (
        <div className="space-y-8">
            <FilePreviewModal />
            {isConfirmModalOpen && (
                <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50">
                    <Card className="max-w-md w-full">
                         <h2 className="text-2xl font-semibold text-white mb-4">Confirm Upload</h2>
                         <div className="space-y-2 text-sm max-h-60 overflow-y-auto pr-2">
                             {filesToUpload.map(file => (
                                 <div key={file.name} className="flex justify-between items-center bg-gray-900/50 p-2 rounded-md">
                                     <span className="truncate text-gray-300">{file.name}</span>
                                     <span className="font-mono text-gray-400">{formatBytes(file.size)}</span>
                                 </div>
                             ))}
                         </div>
                         <div className="mt-6 border-t border-gray-700 pt-4 space-y-3">
                             <div className="flex justify-between font-semibold">
                                 <span className="text-gray-300">Total Size</span>
                                 <span className="text-white">{formatBytes(filesToUpload.reduce((a,b) => a+b.size, 0))}</span>
                             </div>
                             <div className="flex justify-between font-semibold">
                                 <span className="text-gray-300">Estimated Cost</span>
                                 <span className="text-teal-400">{uploadCost.toFixed(4)} LUME</span>
                             </div>
                         </div>
                         <div className="mt-6 flex justify-end gap-4">
                            <Button variant="secondary" onClick={() => setIsConfirmModalOpen(false)}>Cancel</Button>
                            <Button onClick={handleConfirmUpload}>Approve & Upload</Button>
                         </div>
                    </Card>
                </div>
            )}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div className="lg:col-span-2">
                    <Card>
                        <h2 className="text-xl font-semibold text-white mb-4">Network Storage</h2>
                         <p className="text-4xl font-bold text-indigo-400 mt-2">{formatBytes(totalNetworkStorage)}</p>
                        <p className="text-sm text-gray-400 mt-1">Total data stored across all supernodes.</p>
                    </Card>
                </div>
                <div className="lg:col-span-1">
                    <Card>
                        <h2 className="text-xl font-semibold text-white mb-4">Your Usage</h2>
                        <p className="text-4xl font-bold text-white mt-2">{formatBytes(storageUsed)}</p>
                        <p className="text-sm text-gray-400 mt-1">Your contribution to the network.</p>
                    </Card>
                </div>
            </div>
            
            <Card className="!p-0">
                <div className="relative h-96">
                    <img src="https://miro.medium.com/v2/resize:fit:700/1*BlDa8LwS7PG8vXE-5dW8Tg.jpeg" className="absolute inset-0 w-full h-full object-cover" alt="World map"/>
                    <div className="absolute inset-0 bg-gray-900/50"></div>
                     <canvas ref={useRef(null)} className="absolute inset-0 w-full h-full"></canvas>
                </div>
            </Card>

             <Card className={`border-2 border-dashed transition-colors ${isDragging ? 'border-indigo-500 bg-indigo-900/10' : 'border-gray-600 hover:border-indigo-600'}`} onDragEnter={handleDragEnter} onDragLeave={handleDragLeave} onDragOver={handleDragOver} onDrop={handleDrop}>
                <input type="file" multiple ref={fileInputRef} onChange={handleFileSelect} className="hidden"/>
                <div className="flex flex-col items-center justify-center text-center p-8">
                    <UploadCloud className="w-16 h-16 text-gray-500 mb-4"/>
                    <h3 className="text-xl font-semibold text-white">Drag & drop files here</h3>
                    <p className="text-gray-400 mt-1">or</p>
                    <Button onClick={() => fileInputRef.current.click()} className="mt-4">Browse Files</Button>
                </div>
            </Card>
            
            <Card>
                 <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h2 className="text-xl font-semibold text-white">My Files</h2>
                    <div className="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <div className="flex items-center border border-gray-700 rounded-lg p-1 bg-gray-900/50">
                           {['All', 'Image', 'PDF', 'Video', 'Archive'].map(type => (
                             <button key={type} onClick={() => setFileTypeFilter(type)} className={`px-3 py-1.5 rounded-md text-sm font-semibold transition-colors ${fileTypeFilter === type ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-gray-700'}`}>
                                {type} ({fileCounts[type]})
                             </button>
                           ))}
                        </div>
                        <div className="relative w-full md:w-auto">
                            <input type="text" placeholder="Search my files..." value={fileSearch} onChange={e => setFileSearch(e.target.value)} className="w-full md:w-64 bg-gray-900 border-2 border-gray-700 rounded-lg py-2 pl-4 pr-10 text-white focus:border-indigo-500 focus:ring-0 transition" />
                            <Search className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
                        </div>
                    </div>
                </div>

                {selectedFiles.length > 0 && 
                    <div className="bg-gray-700/50 p-3 rounded-lg flex justify-between items-center mb-4">
                        <span className="text-sm font-semibold text-white">{selectedFiles.length} file(s) selected</span>
                        <Button variant="secondary" className="!py-1.5 !px-4"><Download className="w-4 h-4" /> Download as .zip</Button>
                    </div>
                }

                <div className="space-y-2">
                     <div className="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-xs font-semibold text-gray-400 uppercase items-center">
                        <div className="col-span-1"><input type="checkbox" className="rounded" onChange={handleSelectAll} checked={selectedFiles.length === filteredFiles.length && filteredFiles.length > 0} /></div>
                        <div className="col-span-4">Name</div>
                        <div className="col-span-2">Last Modified</div>
                        <div className="col-span-2">TX ID</div>
                        <div className="col-span-1 text-right">Size</div>
                        <div className="col-span-2 text-right">Action</div>
                    </div>
                    {filteredFiles.map((file, index) => (
                        <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-4 items-center bg-gray-900/40 hover:bg-gray-800/60 p-4 rounded-lg">
                            <div className="col-span-full md:col-span-1 flex items-center">
                                <input type="checkbox" className="rounded" checked={selectedFiles.includes(file.name)} onChange={() => handleSelectFile(file.name)} />
                            </div>
                            <div className="col-span-full md:col-span-4 flex items-center gap-4 cursor-pointer" onClick={() => handleRowClick(file)}>
                                {getFileIcon(getSimplifiedType(file.type))}
                                <span className="font-medium text-white truncate">{file.name}</span>
                            </div>
                             <div className="col-span-full md:col-span-2 text-sm text-gray-400">
                                <span className="md:hidden font-semibold text-gray-500 mr-2">Modified: </span>
                                {new Date(file.lastModified).toLocaleDateString()}
                             </div>
                             <div className="col-span-full md:col-span-2 text-sm">
                                <a href="#" className="font-mono text-indigo-400 hover:underline truncate flex items-center gap-1.5">{`${file.txId.substring(0,6)}...${file.txId.substring(file.txId.length - 6)}`}<ArrowUpRight className="w-3 h-3"/></a>
                             </div>
                             <div className="col-span-full md:col-span-1 text-sm text-gray-300 md:text-right">
                                 <span className="md:hidden font-semibold text-gray-500 mr-2">Size: </span>
                                 {formatBytes(file.size)}
                             </div>
                              <div className="col-span-full md:col-span-2 flex justify-end">
                                 <Button variant="secondary" className="!py-1.5 !px-4 text-sm w-full md:w-auto"><Download className="w-4 h-4"/> Download</Button>
                             </div>
                        </div>
                    ))}
                </div>
            </Card>
        </div>
    );
};

const Sense = () => {
    const [image, setImage] = useState(null);
    const [imageName, setImageName] = useState('');
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [analysisResult, setAnalysisResult] = useState(null);
    const [analysisHistory, setAnalysisHistory] = useState([]);
    const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
    const [detailedReport, setDetailedReport] = useState(null);

    const fileInputRef = useRef(null);
    const ANALYSIS_COST = 10;
    
    useEffect(() => {
        setAnalysisHistory([
            {
                image: 'https://placehold.co/100x100/1f2937/a78bfa?text=Hist1',
                imageName: 'historic_analysis_1.png',
                txId: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
                rarenessScore: 92,
                aiConfidence: 5,
                aiModelsChecked: ["DALL-E 2", "Midjourney v5"],
                imageMetadata: { Resolution: "2048x2048", Format: "PNG", "Color Profile": "sRGB"},
            },
            {
                image: 'https://placehold.co/100x100/1f2937/f472b6?text=Hist2',
                imageName: 'another_past_image.jpg',
                txId: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
                rarenessScore: 81,
                aiConfidence: 88,
                 aiModelsChecked: ["DALL-E 2", "Midjourney v5", "Stable Diffusion XL"],
                imageMetadata: { Resolution: "1024x1024", Format: "JPG", "Color Profile": "sRGB"},
            }
        ])
    }, []);

    const handleImageUpload = (file) => {
        if (file && file.type.startsWith('image')) {
            const reader = new FileReader();
            reader.onloadend = () => {
                setImage(reader.result);
                setImageName(file.name);
                setAnalysisResult(null); 
            };
            reader.readAsDataURL(file);
        }
    };
    
    const handleAnalyzeClick = () => {
        if (image) {
            setIsConfirmModalOpen(true);
        }
    }

    const handleConfirmAnalysis = () => {
        setIsConfirmModalOpen(false);
        setIsAnalyzing(true);
        setTimeout(() => {
            const result = {
                image,
                imageName,
                txId: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
                rarenessScore: Math.floor(Math.random() * 21) + 80,
                aiConfidence: Math.random() < 0.5 ? Math.floor(Math.random() * 20) : Math.floor(Math.random() * 30) + 70,
                similarImages: Array.from({length: 10}, (_, i) => `https://picsum.photos/seed/${Math.random()}/400/300`),
                aiModelsChecked: ["DALL-E 2", "Midjourney v5", "Stable Diffusion XL"],
                imageMetadata: { Resolution: "1024x1024", Format: "PNG", "Color Profile": "sRGB"},
            };
            setAnalysisResult(result);
            setAnalysisHistory(prev => [result, ...prev]);
            setIsAnalyzing(false);
            setImage(null);
            setImageName('');
        }, 3000);
    };
    
    return (
        <div className="space-y-8">
            {isConfirmModalOpen && (
                 <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50">
                    <Card className="max-w-md w-full">
                         <h2 className="text-2xl font-semibold text-white mb-4">Confirm Analysis</h2>
                         <p className="text-gray-300 mb-6">Analyzing this image will incur a one-time fee.</p>
                         <div className="mt-6 border-t border-gray-700 pt-4 space-y-3">
                             <div className="flex justify-between font-semibold">
                                 <span className="text-gray-300">Transaction Cost</span>
                                 <span className="text-teal-400">{ANALYSIS_COST} LUME</span>
                             </div>
                         </div>
                         <div className="mt-6 flex justify-end gap-4">
                            <Button variant="secondary" onClick={() => setIsConfirmModalOpen(false)}>Cancel</Button>
                            <Button onClick={handleConfirmAnalysis}>Approve & Analyze</Button>
                         </div>
                    </Card>
                </div>
            )}
             {detailedReport && (
                <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50" onClick={() => setDetailedReport(null)}>
                    <Card className="max-w-4xl w-full" onClick={e => e.stopPropagation()}>
                        <h2 className="text-3xl font-semibold text-white mb-4">Detailed Analysis Report</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                           <div>
                             <img src={detailedReport.image} alt={detailedReport.imageName} className="rounded-lg w-full h-auto object-cover"/>
                             <p className="text-sm text-gray-400 mt-2">{detailedReport.imageName}</p>
                           </div>
                           <div className="space-y-6">
                                <Card>
                                    <h3 className="font-semibold text-white mb-2">Scores</h3>
                                    <div className="flex justify-between"><span className="text-gray-400">Rareness Score</span><span className="font-bold text-indigo-400">{detailedReport.rarenessScore}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-400">AI Confidence</span><span className={`font-bold ${detailedReport.aiConfidence > 50 ? 'text-red-400' : 'text-green-400'}`}>{detailedReport.aiConfidence}%</span></div>
                                </Card>
                                <Card>
                                    <h3 className="font-semibold text-white mb-2">AI Models Checked</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {detailedReport.aiModelsChecked.map(model => <span key={model} className="bg-gray-700 text-xs font-medium px-2 py-1 rounded-md">{model}</span>)}
                                    </div>
                                </Card>
                                 <Card>
                                    <h3 className="font-semibold text-white mb-2">Image Metadata</h3>
                                    {Object.entries(detailedReport.imageMetadata).map(([key, value]) => <div key={key} className="flex justify-between text-sm"><span className="text-gray-400">{key}</span><span>{value}</span></div>)}
                                </Card>
                           </div>
                        </div>
                         <div className="mt-6 flex justify-end">
                             <Button onClick={() => setDetailedReport(null)}>Close</Button>
                         </div>
                    </Card>
                </div>
            )}
            <div className="text-center">
                <h1 className="text-4xl font-bold text-white">Image Authenticity Analysis</h1>
                <p className="text-lg text-gray-400 mt-2 max-w-2xl mx-auto">Upload an image to assess its relative rareness, detect potential AI generation, and find similar assets across the internet.</p>
            </div>
            
            <Card className="max-w-3xl mx-auto">
                {!image && !isAnalyzing && (
                     <div className="flex flex-col items-center justify-center text-center p-8">
                        <input type="file" accept="image/*" ref={fileInputRef} onChange={e => handleImageUpload(e.target.files[0])} className="hidden"/>
                        <ShieldCheck className="w-16 h-16 text-gray-500 mb-4"/>
                        <h3 className="text-xl font-semibold text-white">Upload an image to start analysis</h3>
                        <p className="text-gray-400 mt-1">.png, .jpg, .webp supported</p>
                        <Button onClick={() => fileInputRef.current.click()} className="mt-4">Browse Image</Button>
                    </div>
                )}
                {image && !isAnalyzing && (
                    <div className="text-center">
                        <img src={image} alt="Upload preview" className="max-h-80 rounded-lg mx-auto mb-4"/>
                        <p className="text-gray-300 mb-6">{imageName}</p>
                        <div className="flex justify-center gap-4">
                            <Button variant="secondary" onClick={() => { setImage(null); setImageName(''); }}>Clear Image</Button>
                            <Button onClick={handleAnalyzeClick}>Analyze Image</Button>
                        </div>
                    </div>
                )}
                {isAnalyzing && (
                    <div className="text-center p-8">
                        <div className="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-500 mx-auto mb-4"></div>
                        <h3 className="text-xl font-semibold text-white">Analyzing Image...</h3>
                        <p className="text-gray-400 mt-1">This may take a moment.</p>
                    </div>
                )}
            </Card>

            {analysisResult && (
                <div className="space-y-8 max-w-5xl mx-auto">
                    <Card>
                         <h2 className="text-2xl font-semibold text-white mb-4">Analysis Results</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div className="md:col-span-1">
                                <img src={analysisResult.image} alt="Analyzed" className="rounded-lg w-full h-auto object-cover"/>
                                <p className="text-sm text-gray-400 mt-2 text-center">{analysisResult.imageName}</p>
                            </div>
                            <div className="md:col-span-2 grid grid-cols-2 gap-8">
                                <div className="flex flex-col items-center justify-center p-4 bg-gray-900/50 rounded-lg">
                                    <p className="text-sm text-gray-400">Rareness Score</p>
                                    <p className="text-6xl font-bold text-indigo-400 my-2">{analysisResult.rarenessScore}</p>
                                    <p className="text-xs text-gray-500 text-center">Higher score indicates a more unique image.</p>
                                </div>
                                <div className="flex flex-col items-center justify-center p-4 bg-gray-900/50 rounded-lg">
                                    <p className="text-sm text-gray-400">AI-Generated</p>
                                    <p className={`text-6xl font-bold my-2 ${analysisResult.aiConfidence > 50 ? 'text-red-400' : 'text-green-400'}`}>
                                        {analysisResult.aiConfidence.toFixed(0)}%
                                    </p>
                                     <p className="text-xs text-gray-500 text-center">{analysisResult.aiConfidence > 50 ? "High confidence of AI origin" : "Likely human-created"}</p>
                                </div>
                            </div>
                        </div>
                    </Card>
                    <Card>
                        <h2 className="text-2xl font-semibold text-white mb-4">Top 10 Closest Images Found</h2>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                            {analysisResult.similarImages.map((imgSrc, i) => (
                                <img key={i} src={imgSrc} alt={`Similar ${i+1}`} className="rounded-lg object-cover w-full h-full aspect-square hover:scale-105 transition-transform duration-300"/>
                            ))}
                        </div>
                    </Card>
                </div>
            )}
            
            <Card>
                <h2 className="text-2xl font-semibold text-white mb-4">Analysis History</h2>
                <div className="space-y-4">
                    {analysisHistory.length > 0 ? analysisHistory.map((item, index) => (
                        <div key={index} onClick={() => setDetailedReport(item)} className="grid grid-cols-1 md:grid-cols-12 gap-4 items-center bg-gray-900/40 p-4 rounded-lg hover:bg-gray-800/60 cursor-pointer transition-colors">
                            <div className="col-span-1">
                                <img src={item.image} alt={item.imageName} className="w-12 h-12 rounded-md object-cover" />
                            </div>
                            <div className="col-span-3 truncate font-medium text-white">{item.imageName}</div>
                            <div className="col-span-3">
                                <a href="#" className="font-mono text-indigo-400 hover:underline truncate flex items-center gap-1.5 text-sm">{`${item.txId.substring(0,8)}...${item.txId.substring(item.txId.length - 8)}`}<ArrowUpRight className="w-3 h-3"/></a>
                            </div>
                            <div className="col-span-2 text-center">
                                <p className="text-xs text-gray-400">Rareness</p>
                                <p className="font-bold text-lg text-indigo-400">{item.rarenessScore}</p>
                            </div>
                            <div className="col-span-2 text-center">
                                <p className="text-xs text-gray-400">AI %</p>
                                <p className={`font-bold text-lg ${item.aiConfidence > 50 ? 'text-red-400' : 'text-green-400'}`}>{item.aiConfidence.toFixed(0)}%</p>
                            </div>
                        </div>
                    )) : (
                        <p className="text-center text-gray-500 py-8">No analysis history yet. Upload an image to get started.</p>
                    )}
                </div>
            </Card>
        </div>
    );
};


// --- MAIN APP COMPONENT ---
export default function App() {
  const [view, setView] = useState('dashboard');
  const [walletConnected, setWalletConnected] = useState(false);
  const [isSidebarOpen, setSidebarOpen] = useState(false);

  const handleNavClick = useCallback((newView) => { setView(newView); }, []);

  const renderView = () => {
    if (!walletConnected) {
      if(view === 'dashboard') { return <UnconnectedView />; }
      return <PlaceholderPage title="Connect Your Wallet" icon={Wallet}>Please connect your wallet to view this page and interact with the Lumera ecosystem.</PlaceholderPage>
    }
    switch (view) {
      case 'dashboard': return <Dashboard onNavClick={handleNavClick}/>;
      case 'staking': return <Staking />;
      case 'governance': return <Governance />;
      case 'cascade': return <Cascade/>;
      case 'sense': return <Sense />;
      case 'inference': return <Inference />;
      case 'nfts': return <NFTs/>;
      default: return <Dashboard onNavClick={handleNavClick}/>;
    }
  };

  return (
    <div className="min-h-screen bg-gray-900 text-white font-sans bg-grid-gray-700/20">
      <Sidebar onNavClick={handleNavClick} activeView={view} isSidebarOpen={isSidebarOpen} setSidebarOpen={setSidebarOpen} />
      <div className="lg:pl-72 flex flex-col flex-1 min-h-screen">
        <Header setSidebarOpen={setSidebarOpen} walletConnected={walletConnected} setWalletConnected={setWalletConnected} setView={setView} activeView={view} />
        <main className="flex-1 pb-8">
          <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {renderView()}
          </div>
        </main>
      </div>
    </div>
  );
}

const NFTs = () => {
    const [nfts, setNfts] = useState([]);
    const [isMinting, setIsMinting] = useState(false);
    const [selectedNft, setSelectedNft] = useState(null);

    const handleMint = (newNft) => {
        setNfts(prev => [newNft, ...prev]);
    };

    if (isMinting) {
        return <MintingProcess onMint={handleMint} onBack={() => setIsMinting(false)} />
    }

    if (selectedNft) {
        return <NFTDetail nft={selectedNft} onBack={() => setSelectedNft(null)} />
    }

    return (
        <div className="space-y-8">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold text-white">My NFT Collection</h1>
                <Button onClick={() => setIsMinting(true)}><PlusCircle className="w-5 h-5"/> Mint New NFT</Button>
            </div>
            
            {nfts.length === 0 ? (
                 <Card className="text-center flex flex-col items-center justify-center h-[60vh] border-2 border-dashed border-gray-600">
                    <div className="bg-gray-700/50 p-4 rounded-full mb-6">
                        <ImageIconLucide className="w-12 h-12 text-indigo-400" />
                    </div>
                    <h2 className="text-2xl font-bold text-white">Your Collection is Empty</h2>
                    <p className="text-gray-400 mt-2 max-w-md">Mint your first on-chain certified NFT to see it here.</p>
                    <Button onClick={() => setIsMinting(true)} className="mt-6">
                        <PlusCircle className="w-5 h-5"/> Mint Your First NFT
                    </Button>
                </Card>
            ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    {nfts.map((nft, index) => (
                        <div key={index} onClick={() => setSelectedNft(nft)} className="bg-gray-800/50 rounded-2xl overflow-hidden group cursor-pointer">
                            <div className="aspect-square overflow-hidden">
                                <img src={nft.imageUrl} alt={nft.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"/>
                            </div>
                            <div className="p-4">
                                <h3 className="font-bold text-white truncate">{nft.name}</h3>
                                <p className="text-sm text-gray-400">LUME NFT #{nft.id}</p>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

const MintingProcess = ({ onMint, onBack }) => {
    const [step, setStep] = useState(1);
    const [nftData, setNftData] = useState({
        name: '',
        description: '',
        image: null,
        imageUrl: '',
        attributes: [{ trait_type: '', value: '' }],
        properties: [{ key: '', value: '' }],
        external_url: '',
        collection: { name: '', family: '' }
    });
    const [isLoading, setIsLoading] = useState(false);

    const handleNext = () => setStep(s => s + 1);
    const handleBack = () => setStep(s => s - 1);

    const handleAttributeChange = (index, field, value) => {
        const newAttributes = [...nftData.attributes];
        newAttributes[index][field] = value;
        setNftData(d => ({ ...d, attributes: newAttributes }));
    };

    const addAttribute = () => {
        if (nftData.attributes.length < 10) {
            setNftData(d => ({ ...d, attributes: [...d.attributes, { trait_type: '', value: '' }] }));
        }
    };

    const removeAttribute = (index) => {
        const newAttributes = [...nftData.attributes];
        newAttributes.splice(index, 1);
        setNftData(d => ({ ...d, attributes: newAttributes }));
    };
    
    const handlePropertyChange = (index, field, value) => {
        const newProperties = [...nftData.properties];
        newProperties[index][field] = value;
        setNftData(d => ({ ...d, properties: newProperties }));
    };

    const addProperty = () => {
        setNftData(d => ({ ...d, properties: [...d.properties, { key: '', value: '' }] }));
    };

    const removeProperty = (index) => {
        const newProperties = [...nftData.properties];
        newProperties.splice(index, 1);
        setNftData(d => ({ ...d, properties: newProperties }));
    };

    const handleImageUpload = (file) => {
        if (file && file.type.startsWith('image')) {
            const reader = new FileReader();
            reader.onloadend = () => {
                setNftData(d => ({ ...d, image: file, imageUrl: reader.result }));
            };
            reader.readAsDataURL(file);
        }
    };

    const finalMint = () => {
        setIsLoading(true);
        // Simulate minting process
        setTimeout(() => {
            const finalNft = {
                ...nftData,
                id: Math.floor(Math.random() * 10000),
                senseTx: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
                cascadeTx: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
                rarenessScore: Math.floor(Math.random() * 100),
                aiConfidence: Math.floor(Math.random() * 100),
            };
            onMint(finalNft);
            onBack();
        }, 2000);
    };

    const steps = [
        "Details", "Attributes", "Properties", "Collection", "Review & Mint"
    ];

    return (
        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50">
            <Card className="w-full max-w-2xl">
                <div className="flex justify-between items-start">
                    <h2 className="text-2xl font-bold text-white mb-2">Mint New NFT</h2>
                    <button onClick={onBack} className="text-gray-400 hover:text-white"><X/></button>
                </div>
                <div className="mb-6">
                    <div className="flex justify-between mb-1">
                        {steps.map((s, i) => (
                            <div key={s} className={`w-full text-center text-sm font-medium ${step > i + 1 ? 'text-indigo-400' : step === i + 1 ? 'text-white' : 'text-gray-500'}`}>{s}</div>
                        ))}
                    </div>
                    <div className="flex">
                        {steps.map((_, i) => (
                             <div key={i} className={`w-full h-1 rounded-full ${step > i ? 'bg-indigo-500' : 'bg-gray-700'}`}></div>
                        ))}
                    </div>
                </div>

                {step === 1 && (
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-300 mb-1">Image</label>
                            <div className="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-md">
                                {nftData.imageUrl ? (
                                    <img src={nftData.imageUrl} alt="Preview" className="max-h-48 rounded-lg"/>
                                ) : (
                                    <div className="space-y-1 text-center">
                                        <ImageIconLucide className="mx-auto h-12 w-12 text-gray-500"/>
                                        <div className="flex text-sm text-gray-400">
                                            <label htmlFor="file-upload" className="relative cursor-pointer bg-gray-800 rounded-md font-medium text-indigo-400 hover:text-indigo-300 focus-within:outline-none">
                                                <span>Upload a file</span>
                                                <input id="file-upload" name="file-upload" type="file" className="sr-only" onChange={e => handleImageUpload(e.target.files[0])} accept="image/*"/>
                                            </label>
                                        </div>
                                        <p className="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div><label className="block text-sm font-medium text-gray-300 mb-1">Name</label><input type="text" value={nftData.name} onChange={e => setNftData({...nftData, name: e.target.value})} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"/></div>
                        <div><label className="block text-sm font-medium text-gray-300 mb-1">Description</label><textarea value={nftData.description} onChange={e => setNftData({...nftData, description: e.target.value})} rows={3} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"></textarea></div>
                        <div><label className="block text-sm font-medium text-gray-300 mb-1">External URL (Optional)</label><input type="text" value={nftData.external_url} onChange={e => setNftData({...nftData, external_url: e.target.value})} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"/></div>
                    </div>
                )}
                
                {step === 2 && (
                    <div className="space-y-4">
                        <h3 className="text-lg font-medium text-white">Attributes</h3>
                        {nftData.attributes.map((attr, index) => (
                            <div key={index} className="flex items-center gap-2">
                                <input type="text" placeholder="Trait Type" value={attr.trait_type} onChange={e => handleAttributeChange(index, 'trait_type', e.target.value)} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"/>
                                <input type="text" placeholder="Value" value={attr.value} onChange={e => handleAttributeChange(index, 'value', e.target.value)} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"/>
                                <button onClick={() => removeAttribute(index)} className="p-2 text-gray-400 hover:text-white"><XCircle className="w-5 h-5"/></button>
                            </div>
                        ))}
                        {nftData.attributes.length < 10 && <Button onClick={addAttribute} variant="ghost"><PlusCircle className="w-4 h-4"/> Add Attribute</Button>}
                    </div>
                )}

                {step === 3 && (
                     <div className="space-y-4">
                        <h3 className="text-lg font-medium text-white">Properties</h3>
                        {nftData.properties.map((prop, index) => (
                            <div key={index} className="flex items-center gap-2">
                                <input type="text" placeholder="Key" value={prop.key} onChange={e => handlePropertyChange(index, 'key', e.target.value)} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"/>
                                <input type="text" placeholder="Value" value={prop.value} onChange={e => handlePropertyChange(index, 'value', e.target.value)} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"/>
                                <button onClick={() => removeProperty(index)} className="p-2 text-gray-400 hover:text-white"><XCircle className="w-5 h-5"/></button>
                            </div>
                        ))}
                        <Button onClick={addProperty} variant="ghost"><PlusCircle className="w-4 h-4"/> Add Property</Button>
                    </div>
                )}

                {step === 4 && (
                    <div className="space-y-4">
                         <h3 className="text-lg font-medium text-white">Collection Details</h3>
                         <div><label className="block text-sm font-medium text-gray-300 mb-1">Collection Name</label><input type="text" value={nftData.collection.name} onChange={e => setNftData({...nftData, collection: {...nftData.collection, name: e.target.value}})} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"/></div>
                         <div><label className="block text-sm font-medium text-gray-300 mb-1">Collection Family</label><input type="text" value={nftData.collection.family} onChange={e => setNftData({...nftData, collection: {...nftData.collection, family: e.target.value}})} className="w-full bg-gray-900/50 border-gray-600 rounded-lg"/></div>
                    </div>
                )}
                
                {step === 5 && (
                     <div className="space-y-4">
                        <h3 className="text-lg font-medium text-white">Review & Mint</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-1">
                                <img src={nftData.imageUrl} alt="Final Preview" className="rounded-lg w-full"/>
                            </div>
                            <div className="md:col-span-2 space-y-2 text-sm">
                                <p><strong className="text-gray-400">Name:</strong> {nftData.name}</p>
                                <p><strong className="text-gray-400">Description:</strong> {nftData.description}</p>
                                {nftData.external_url && <p><strong className="text-gray-400">External URL:</strong> <a href={nftData.external_url} className="text-indigo-400">{nftData.external_url}</a></p>}
                                <p><strong className="text-gray-400">Collection:</strong> {nftData.collection.name} ({nftData.collection.family})</p>
                                <div><strong className="text-gray-400">Attributes:</strong>
                                    <div className="flex flex-wrap gap-2 mt-1">
                                        {nftData.attributes.map((a,i) => a.trait_type && a.value && <span key={i} className="bg-indigo-500/20 text-indigo-300 text-xs font-medium px-2.5 py-0.5 rounded-full">{a.trait_type}: {a.value}</span>)}
                                    </div>
                                </div>
                                <div><strong className="text-gray-400">Properties:</strong>
                                    <div className="flex flex-wrap gap-2 mt-1">
                                        {nftData.properties.map((p,i) => p.key && p.value && <span key={i} className="bg-sky-500/20 text-sky-300 text-xs font-medium px-2.5 py-0.5 rounded-full">{p.key}: {p.value}</span>)}
                                    </div>
                                </div>
                                <div className="pt-4 border-t border-gray-700/50 space-y-2">
                                    <div className="flex justify-between font-semibold"><span className="text-gray-300">Total Cost</span><span className="text-teal-400">5 LUME</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                <div className="mt-8 flex justify-between">
                    <Button onClick={handleBack} variant="secondary" disabled={step === 1 || isLoading}>Back</Button>
                    {step < 5 && <Button onClick={handleNext}>Next</Button>}
                    {step === 5 && <Button onClick={finalMint} disabled={isLoading}>{isLoading ? "Minting..." : "Mint NFT"}</Button>}
                </div>
            </Card>
        </div>
    );
};

const NFTDetail = ({ nft, onBack }) => {
    return (
        <div className="space-y-8">
            <div>
                <button onClick={onBack} className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4"><ChevronLeft className="w-5 h-5"/>Back to Collection</button>
            </div>
            <Card>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <img src={nft.imageUrl} alt={nft.name} className="rounded-lg w-full h-auto object-cover aspect-square"/>
                    <div className="space-y-6">
                        <h1 className="text-4xl font-bold text-white">{nft.name}</h1>
                        <p className="text-gray-300">{nft.description}</p>
                        
                        {nft.external_url && 
                            <div className="pt-4 border-t border-gray-700/50">
                                <a href={nft.external_url} target="_blank" rel="noopener noreferrer" className="text-indigo-400 hover:underline flex items-center gap-2">
                                    <LinkIcon className="w-4 h-4"/> Visit External URL
                                </a>
                            </div>
                        }

                        <div className="space-y-4 pt-4 border-t border-gray-700/50">
                            <h3 className="text-lg font-semibold text-white">On-Chain Data</h3>
                            <div className="flex justify-between text-sm"><span className="text-gray-400">Token ID</span><span className="font-mono text-white">#{nft.id}</span></div>
                            <div className="flex justify-between text-sm"><span className="text-gray-400">Sense TX</span><a href="#" className="font-mono text-indigo-400 hover:underline truncate">{nft.senseTx.substring(0, 16)}...</a></div>
                            <div className="flex justify-between text-sm"><span className="text-gray-400">Cascade TX</span><a href="#" className="font-mono text-indigo-400 hover:underline truncate">{nft.cascadeTx.substring(0, 16)}...</a></div>
                        </div>

                         <div className="space-y-4 pt-4 border-t border-gray-700/50">
                            <h3 className="text-lg font-semibold text-white">Sense Analysis</h3>
                            <div className="flex justify-between text-sm"><span className="text-gray-400">Rareness Score</span><span className="font-bold text-indigo-400">{nft.rarenessScore}</span></div>
                            <div className="flex justify-between text-sm"><span className="text-gray-400">AI-Generated Confidence</span><span className={`font-bold ${nft.aiConfidence > 50 ? 'text-red-400' : 'text-green-400'}`}>{nft.aiConfidence}%</span></div>
                        </div>
                        
                        {nft.attributes && nft.attributes.some(a=>a.trait_type) && (
                            <div className="space-y-2 pt-4 border-t border-gray-700/50">
                                <h3 className="text-lg font-semibold text-white">Attributes</h3>
                                <div className="flex flex-wrap gap-2">
                                    {nft.attributes.map((attr, i) => attr.trait_type && attr.value && <span key={i} className="bg-indigo-500/20 text-indigo-300 text-xs font-medium px-2.5 py-1 rounded-full">{attr.trait_type}: {attr.value}</span>)}
                                </div>
                            </div>
                        )}
                        
                        {nft.properties && nft.properties.some(p=>p.key) && (
                            <div className="space-y-2 pt-4 border-t border-gray-700/50">
                                <h3 className="text-lg font-semibold text-white">Properties</h3>
                                <div className="flex flex-wrap gap-2">
                                    {nft.properties.map((prop, i) => prop.key && prop.value && <span key={i} className="bg-sky-500/20 text-sky-300 text-xs font-medium px-2.5 py-1 rounded-full">{prop.key}: {prop.value}</span>)}
                                </div>
                            </div>
                        )}

                        {nft.collection && nft.collection.name && (
                             <div className="space-y-2 pt-4 border-t border-gray-700/50">
                                <h3 className="text-lg font-semibold text-white">Collection</h3>
                                <div className="flex justify-between text-sm"><span className="text-gray-400">Name</span><span className="font-semibold text-white">{nft.collection.name}</span></div>
                                {nft.collection.family && <div className="flex justify-between text-sm"><span className="text-gray-400">Family</span><span className="font-semibold text-white">{nft.collection.family}</span></div>}
                            </div>
                        )}
                    </div>
                </div>
            </Card>
        </div>
    );
};

const Inference = () => {
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedModel, setSelectedModel] = useState(AI_MODELS[0]);
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const attachmentInputRef = useRef(null);
    const [sortConfig, setSortConfig] = useState({ key: 'prompted', direction: 'descending' });

    const trendingModel = useMemo(() => {
        if (!AI_MODELS || AI_MODELS.length === 0) return null;
        return AI_MODELS.reduce((prev, current) => (prev.prompted > current.prompted) ? prev : current);
    }, []);

    const sortedModels = useMemo(() => {
        let sortableItems = [...AI_MODELS];
        if (sortConfig !== null) {
            sortableItems.sort((a, b) => {
                if (a[sortConfig.key] < b[sortConfig.key]) {
                    return sortConfig.direction === 'ascending' ? -1 : 1;
                }
                if (a[sortConfig.key] > b[sortConfig.key]) {
                    return sortConfig.direction === 'ascending' ? 1 : -1;
                }
                return 0;
            });
        }
        return sortableItems;
    }, [sortConfig]);

    const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        }
        setSortConfig({ key, direction });
    };
    
    const filteredAndSortedModels = useMemo(() => 
        sortedModels.filter(m => 
            m.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            m.owner.toLowerCase().includes(searchQuery.toLowerCase())
        ), [sortedModels, searchQuery]);

    const handleSend = () => {
        if(!input.trim()) return;

        const userMessage = { sender: 'user', text: input };
        setMessages(prev => [...prev, userMessage]);
        
        setTimeout(() => {
            const aiResponse = { sender: 'ai', text: `This is a simulated response from ${selectedModel.name} regarding: "${input}"` };
            setMessages(prev => [...prev, aiResponse]);
        }, 1500);

        setInput('');
    }

    const handleAttachment = (e) => {
        if (e.target.files && e.target.files[0]) {
            const fileName = e.target.files[0].name;
            const userMessage = { sender: 'user', text: `Attached: ${fileName}` };
            setMessages(prev => [...prev, userMessage]);
        }
    };

    return (
        <div className="space-y-8">
            <div className="text-center">
                <h1 className="text-4xl font-bold text-white">AI Model Inference</h1>
                <p className="text-lg text-gray-400 mt-2 max-w-2xl mx-auto">Discover and utilize a growing library of AI models available on the Lumera network.</p>
            </div>
             <Card>
                <h2 className="text-xl font-semibold text-white mb-4">AI Chat</h2>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-2">
                        <div className="bg-gray-900/50 p-4 rounded-t-lg h-96 overflow-y-auto flex flex-col gap-4">
                           {messages.map((msg, i) => (
                               <div key={i} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                   <div className={`max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-2xl ${msg.sender === 'user' ? 'bg-indigo-600' : 'bg-gray-700'}`}>
                                       {msg.text}
                                   </div>
                               </div>
                           ))}
                        </div>
                         <div className="flex items-center p-2 bg-gray-800 rounded-b-lg">
                            <input type="file" ref={attachmentInputRef} className="hidden" onChange={handleAttachment} />
                            <button onClick={() => attachmentInputRef.current.click()} className="p-2 text-gray-400 hover:text-white transition-colors">
                                <Paperclip className="w-5 h-5"/>
                            </button>
                            <input
                                type="text"
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && handleSend()}
                                placeholder="Type your prompt here..."
                                className="w-full bg-transparent text-white placeholder-gray-400 focus:ring-0 border-0"
                            />
                            <Button onClick={handleSend} className="!px-4 !py-2"><Send className="w-5 h-5"/></Button>
                        </div>
                    </div>
                     <div className="lg:col-span-1">
                        <h3 className="font-semibold text-white mb-2">Select Model</h3>
                        <div className="space-y-2">
                            {AI_MODELS.map(model => (
                                <div key={model.name} onClick={() => setSelectedModel(model)} className={`p-3 rounded-lg cursor-pointer transition-colors ${selectedModel.name === model.name ? 'bg-indigo-600/30' : 'bg-gray-900/50 hover:bg-gray-800/80'}`}>
                                    <div className="flex justify-between items-center">
                                        <span className="font-semibold text-white flex items-center gap-2">
                                          {model.name}
                                          {trendingModel && model.name === trendingModel.name && ''}
                                        </span>
                                        {selectedModel.name === model.name && <CheckCircle className="w-5 h-5 text-indigo-400"/>}
                                    </div>
                                    <p className="text-xs text-gray-400 mt-1">Fee: {model.fee} LUME / prompt</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </Card>
            <Card>
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h2 className="text-xl font-semibold text-white">Available Models</h2>
                    <div className="relative w-full md:w-auto">
                        <input type="text" placeholder="Search models..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full md:w-64 bg-gray-900 border-2 border-gray-700 rounded-lg py-2 pl-4 pr-10 text-white focus:border-indigo-500 focus:ring-0 transition" />
                        <Search className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <div className="min-w-[700px] space-y-2">
                        <div className="grid grid-cols-12 gap-4 px-4 py-2 text-xs font-semibold text-gray-400 uppercase">
                            <div className="col-span-4 cursor-pointer flex items-center gap-1" onClick={() => requestSort('name')}>Model Name {sortConfig.key === 'name' && (sortConfig.direction === 'ascending' ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />)}</div>
                            <div className="col-span-3">Owner</div>
                            <div className="col-span-3 text-right cursor-pointer flex items-center justify-end gap-1" onClick={() => requestSort('prompted')}>Times Prompted {sortConfig.key === 'prompted' && (sortConfig.direction === 'ascending' ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />)}</div>
                            <div className="col-span-2 text-right cursor-pointer flex items-center justify-end gap-1" onClick={() => requestSort('fee')}>Fee {sortConfig.key === 'fee' && (sortConfig.direction === 'ascending' ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />)}</div>
                        </div>
                        {filteredAndSortedModels.map((model, i) => (
                             <div key={i} className="grid grid-cols-12 gap-4 items-center bg-gray-900/40 p-4 rounded-lg">
                                <div className="col-span-4 font-semibold text-white flex items-center gap-2">{model.name} {trendingModel && model.name === trendingModel.name && ''}</div>
                                <div className="col-span-3 font-mono text-sm text-gray-300 truncate">{model.owner}</div>
                                <div className="col-span-3 text-right font-mono text-gray-300">{model.prompted.toLocaleString()}</div>
                                <div className="col-span-2 text-right font-mono text-teal-400">{model.fee} LUME</div>
                            </div>
                        ))}
                    </div>
                </div>
            </Card>
        </div>
    )
}

const style = document.createElement('style');
style.innerHTML = `.bg-grid-gray-700\\/20 { background-image: linear-gradient(to right, rgba(55, 65, 81, 0.1) 1px, transparent 1px), linear-gradient(to bottom, rgba(55, 65, 81, 0.1) 1px, transparent 1px); background-size: 3rem 3rem; }`;
document.head.appendChild(style);
const headlessUiScript = document.createElement('script');
headlessUiScript.src = "https://cdn.jsdelivr.net/npm/@headlessui/react@1.7.17/dist/headlessui.production.min.js";
document.head.appendChild(headlessUiScript);
